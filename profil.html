<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#eef2ff" />
    <script src="seed-data.js"></script>
    <title>SmartSave – Mon profil</title>
    <link rel="stylesheet" href="styles.css?v=20260212-01" />
    <link rel="stylesheet" href="theme-polish.css" />
  </head>
  <body class="profile-page" data-page="profil">
      <div class="profile-overlay">
        <button type="button" class="profile-modal__close" aria-label="Fermer la page profil" onclick="history.back()">
          <span aria-hidden="true">✕</span>
        </button>
        <main class="profile-modal__content profile-clean profile-links">
          <div class="section-header profile-title">
            <h1>Ton profil — <span data-profile-name>—</span></h1>
          </div>
          <div class="profile-categories--grid" data-categories></div>
        </main>
      </div>
      <div hidden data-profile-meta></div>
      <div hidden data-summary-stats></div>
      <div hidden data-profile-grid></div>

    <script>
      const STORAGE_KEY_FORM = "smartsaveFormData";
      const STORAGE_KEY_ACTIVE_USER = "smartsaveActiveUser";

      const CATEGORY_DEFINITIONS = [
        { section: "personal", label: "Informations personnelles", description: "Mon identité et statut", icon: "M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-3 0-6 1.5-6 3.5V19h12v-1.5c0-2-3-3.5-6-3.5z" },
        { section: "assets", label: "Mes comptes et liquidités", description: "Solde et réserves", icon: "M4 11h16v8H4zM6 5h12v4H6z" },
        { section: "incomes", label: "Revenus", description: "Toutes mes sources de revenu", icon: "M4 12h16M4 16h10M4 8h6", stroke: true },
        { section: "expenses", label: "Dépenses", description: "Charges fixes et variables", icon: "M4 6h16M4 12h16M4 18h16", stroke: true },
        { section: "investments", label: "Investissements", description: "Portefeuille actif", icon: "M12 4l2.5 4.5L18 11l-3 2.5L14 18l-4-2.5L6 18l-.5-4.5L2 11l3.5-2.5z" },
        { section: "credits", label: "Crédits et dettes", description: "Ce que je dois", icon: "M5 8h7v4H5zM5 14h11v4H5z" },
        { section: "taxes", label: "Impôts", description: "Informations fiscales", icon: "M5 12h6M5 16h10M5 8h10", stroke: true },
        { section: "vision", label: "Vision & priorités", description: "Mes objectifs financiers", icon: "M12 5l3 3-3 3-3-3zM6 12l6 7 6-7" },
      ];

      const HERO_META_FIELDS = [
        { label: "Canton", path: "personal.canton" },
        { label: "Statut pro", path: "personal.employmentStatus" },
        { label: "État civil", path: "personal.maritalStatus" },
        { label: "Enfants", path: "personal.childrenCount" },
      ];

      const toNumber = (value) => {
        const parsed = Number(String(value ?? "").replace(/[^0-9.-]/g, ""));
        return Number.isFinite(parsed) ? parsed : 0;
      };

      const formatCurrency = (value) =>
        new Intl.NumberFormat("fr-CH", {
          style: "currency",
          currency: "CHF",
          maximumFractionDigits: 0,
        }).format(Number.isFinite(value) ? value : toNumber(value));

      const readStorage = (key) => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch (_error) {
          return null;
        }
      };

      const loadActiveUser = () => {
        if (typeof window.loadActiveUser === "function") return window.loadActiveUser();
        return readStorage(STORAGE_KEY_ACTIVE_USER);
      };

      const loadUserForm = (userId) => {
        if (typeof window.loadUserForm === "function") return window.loadUserForm(userId);
        const data = readStorage(STORAGE_KEY_FORM);
        if (!data) return null;
        if (userId && data[userId]) return data[userId];
        return data.__default || data;
      };

      const clearActiveUser = () => {
        try {
          localStorage.setItem(STORAGE_KEY_ACTIVE_USER, "{}");
        } catch (_error) {
          // ignore storage issues
        }
      };

      const getIncomeMonthlyAmount = (entry = {}) => {
        const amount = toNumber(entry?.amount);
        if (!amount) return 0;
        const type = String(entry?.amountType || "net").toLowerCase();
        const coefficient = type === "brut" ? 0.86 : 1;
        const hasThirteenth = entry?.thirteenth === "oui";
        const netMonthly = amount * coefficient;
        return hasThirteenth ? (netMonthly * 13) / 12 : netMonthly;
      };

      const resolveMonthlyExpenseAmount = (entry = {}) => {
        const amount = toNumber(entry?.amount);
        const frequency = String(entry?.frequency || "mensuel").toLowerCase();
        if (!amount) return 0;
        if (frequency.includes("ann")) return amount / 12;
        if (frequency.includes("trim")) return amount / 3;
        return amount;
      };

      const renderHtml = (container, html) => {
        if (!container) return;
        container.innerHTML = html;
      };

      const renderGrid = (container, fields, data) => {
        if (!container) return;
        container.innerHTML = "";
        fields.forEach((field) => {
          const value = toNumber(field.value ? field.value(data) : field.path.split(".").reduce((acc, key) => (acc ? acc[key] : null), data));
          const display = field.format === "currency" ? formatCurrency(value) : value || "—";
          const item = document.createElement("div");
          item.className = "profile-item";
          item.innerHTML = `<span class="profile-item__label">${field.label}</span><span class="profile-item__value">${display}</span>`;
          container.appendChild(item);
        });
      };

      const renderHeroGrid = (container, data) => {
        if (!container) return;
        container.innerHTML = "";
        HERO_META_FIELDS.forEach((field) => {
          const raw = field.path.split(".").reduce((acc, key) => (acc ? acc[key] : null), data);
          const value = raw || "—";
          const item = document.createElement("div");
          item.className = "profile-item";
          item.innerHTML = `<span class="profile-item__label">${field.label}</span><span class="profile-item__value">${value}</span>`;
          container.appendChild(item);
        });
      };

      const renderSummaryStats = (container, stats) => {
        if (!container) return;
        container.innerHTML = "";
        stats.forEach((stat) => {
          const card = document.createElement("div");
          card.className = "profile-stat";
          card.innerHTML = `
            <span class="profile-stat__label">${stat.label}</span>
            <span class="profile-stat__value">${formatCurrency(stat.value)}</span>
          `;
          container.appendChild(card);
        });
      };

      const PROFILE_FROM_STORAGE = "profileLastMain";
      const profileFromQuery = new URLSearchParams(window.location.search).get("from");
      const storedProfileSource = localStorage.getItem(PROFILE_FROM_STORAGE) || "mon-argent.html";
      const profileSource = profileFromQuery || storedProfileSource;
      localStorage.setItem(PROFILE_FROM_STORAGE, profileSource);

      const renderCategories = (container, fromPath) => {
        if (!container) return;
        container.innerHTML = "";
        CATEGORY_DEFINITIONS.forEach((category) => {
          const link = document.createElement("a");
          link.className = "profile-category";
          link.href = `profil-section.html?section=${category.section}&from=${encodeURIComponent(fromPath)}`;
          const svgAttrs = category.stroke
            ? 'stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"'
            : 'fill="currentColor"';
          link.innerHTML = `
            <div class="profile-category__main">
              <svg viewBox="0 0 24 24" aria-hidden="true" ${svgAttrs}><path d="${category.icon}"/></svg>
              <span class="profile-category__label">${category.label}</span>
            </div>
            <span class="profile-category__arrow" aria-hidden="true">➜</span>
          `;
          container.appendChild(link);
        });
      };

      const getUserDisplayName = (activeUser = {}, formData = {}) => {
        const personal = formData.personal || {};
        const fullName = [
          personal.firstName || personal.prenom,
          personal.lastName || personal.nom,
        ]
          .filter(Boolean)
          .join(" ");
        return (
          personal.fullName ||
          personal.displayName ||
          activeUser.displayName ||
          activeUser.name ||
          fullName ||
          "Profil"
        );
      };

      document.addEventListener("DOMContentLoaded", () => {
        const activeUser = loadActiveUser() || {};
        const formData = loadUserForm(activeUser.id) || {};
        document.querySelectorAll("[data-user-name], .user-name, [data-profile-name]").forEach((node) => {
          node.textContent = getUserDisplayName(activeUser, formData);
        });

        renderHeroGrid(document.querySelector("[data-profile-meta]"), formData);

        const incomes = Array.isArray(formData.incomes?.entries) ? formData.incomes.entries : [];
        const fixedExpenses = Array.isArray(formData.expenses?.fixed) ? formData.expenses.fixed : [];
        const variableExpenses = Array.isArray(formData.expenses?.variable) ? formData.expenses.variable : [];

        const monthlyIncome = incomes.reduce((sum, entry) => sum + Math.max(0, getIncomeMonthlyAmount(entry)), 0) + toNumber(formData.incomes?.spouseNetIncome) / 12;
        const fixed = fixedExpenses.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        const variable = variableExpenses.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        const assets = toNumber(formData.assets?.liquidAssetsTotal) || toNumber(formData.assets?.currentAccount) + toNumber(formData.assets?.savingsAccount);

        const summaryStats = [
          { label: "Revenu mensuel", value: monthlyIncome },
          { label: "Charges fixes", value: fixed },
          { label: "Charges variables", value: variable },
          { label: "Liquidités", value: assets },
        ];

        renderSummaryStats(document.querySelector("[data-summary-stats]"), summaryStats);

        renderCategories(document.querySelector("[data-categories]"), profileSource);
        const closeButton = document.querySelector(".profile-modal__close");
        closeButton?.addEventListener("click", () => {
          window.location.href = profileSource;
        });

        const profileGrid = document.querySelector("[data-profile-grid]");
        profileGrid.innerHTML = "";
        const metaFields = [
          { label: "Revenu mensuel", value: monthlyIncome },
          { label: "Charges totales", value: fixed + variable },
          { label: "Valeur nette", value: toNumber(formData.credits?.assetsTotal) },
          { label: "Dettes totales", value: toNumber(formData.credits?.debtsTotal) },
        ];
        metaFields.forEach((item) => {
          const node = document.createElement("div");
          node.className = "profile-item";
          node.innerHTML = `<span class="profile-item__label">${item.label}</span><span class="profile-item__value">${formatCurrency(item.value)}</span>`;
          profileGrid.appendChild(node);
        });

        const userMenuButton = document.querySelector(".user-pill--account");
        const userMenu = document.querySelector(".user-menu");
        const hamburgerButton = document.querySelector(".menu-button");
        const hamburgerMenu = document.querySelector(".hamburger-menu");
        userMenuButton?.addEventListener("click", () => {
          const expanded = userMenuButton.getAttribute("aria-expanded") === "true";
          userMenuButton.setAttribute("aria-expanded", String(!expanded));
          userMenu?.classList.toggle("open", !expanded);
        });
        hamburgerButton?.addEventListener("click", () => {
          const expanded = hamburgerButton.getAttribute("aria-expanded") === "true";
          hamburgerButton.setAttribute("aria-expanded", String(!expanded));
          hamburgerMenu?.classList.toggle("open", !expanded);
        });
        document.addEventListener("click", (event) => {
          if (!event.target.closest(".user-menu-wrapper")) {
            userMenuButton?.setAttribute("aria-expanded", "false");
            userMenu?.classList.remove("open");
          }
          if (!event.target.closest(".hamburger-wrapper")) {
            hamburgerButton?.setAttribute("aria-expanded", "false");
            hamburgerMenu?.classList.remove("open");
          }
          const action = event.target.closest("[data-user-action]");
          if (!action) return;
          const type = action.getAttribute("data-user-action");
          if (type === "edit") {
            window.location.href = "profil.html";
          }
          if (type === "logout") {
            clearActiveUser();
            window.location.href = "index.html";
          }
        });
      });
    </script>
  </body>
</html>
