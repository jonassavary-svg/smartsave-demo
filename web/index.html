<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>SmartSave | Analyse financière instantanée</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#eef2ff">
  <script src="seed-data.js"></script>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SmartSave">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <link rel="stylesheet" href="styles.css?v=20260212-01">
</head>
<body class="smartsave-page entry-page">
  <main class="smartsave-shell entry-shell" aria-label="Accueil SmartSave">
    <section class="entry-card" aria-labelledby="entry-title">
      <a class="logo entry-logo" href="index.html" aria-label="SmartSave">
        <span class="logo-mark" aria-hidden="true">S</span>
        <span class="logo-text">SmartSave</span>
      </a>
      <p class="entry-eyebrow">Personal Finance</p>
      <h1 id="entry-title" class="entry-title">Reprenez le contrôle de votre budget, simplement.</h1>
      <p class="entry-subtitle">
        Renseignez votre nom pour reprendre votre profil ou démarrer votre parcours SmartSave.
      </p>

      <form class="entry-form" action="formulaire.html">
        <div class="entry-form__row">
          <label class="field entry-field">
            <span class="field-label">Prénom</span>
            <input type="text" name="prenom" placeholder="Alice" autocomplete="given-name" required>
          </label>
          <label class="field entry-field">
            <span class="field-label">Nom</span>
            <input type="text" name="nom" placeholder="Dupont" autocomplete="family-name" required>
          </label>
        </div>
        <button class="cta entry-cta" type="submit">Commencer</button>
      </form>

      <p class="entry-note">
        Vos données restent privées et vous gardez le contrôle à chaque étape.
      </p>
    </section>
  </main>
  <script>
    (function () {
      const STORAGE_KEY_FORM = "smartsaveFormData";
      const STORAGE_KEY_ACTIVE_USER = "smartsaveActiveUser";
      const NAME_INDEX_KEY = "smartsaveNameIndex";
      const PENDING_NAME_KEY = "smartsavePendingName";
      const RECAP_PENDING_KEY = "smartsaveRecapPendingByUser";
      const form = document.querySelector(".entry-form");
      const firstNameInput = form?.querySelector("input[name='prenom']");
      const lastNameInput = form?.querySelector("input[name='nom']");

      if (!form || !firstNameInput || !lastNameInput) {
        return;
      }

      const activeUser = safeParse(localStorage.getItem(STORAGE_KEY_ACTIVE_USER));
      const storedForms = safeParse(localStorage.getItem(STORAGE_KEY_FORM)) || {};
      if (activeUser?.id && (storedForms[activeUser.id] || storedForms.__default)) {
        window.location.href = resolvePostLoginTarget(activeUser.id);
        return;
      }

      form.addEventListener("submit", (event) => {
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        if (!firstName || !lastName) {
          return;
        }

        const normalizedKey = createNameKey(firstName, lastName);
        const match = findMatchingProfile(normalizedKey);
        if (match) {
          event.preventDefault();
          activateUser(match, firstName, lastName);
          cleanupPendingName();
          window.location.href = resolvePostLoginTarget(match.id);
          return;
        }

        const newId = generateUserId();
        const activeUser = {
          id: newId,
          firstName,
          lastName,
          displayName: `${firstName} ${lastName}`.trim(),
        };
        localStorage.setItem(STORAGE_KEY_ACTIVE_USER, JSON.stringify(activeUser));
        setPendingName({ key: normalizedKey, firstName, lastName, userId: newId });
        // Ensure navigation even if default submit is blocked.
        event.preventDefault();
        window.location.href = "formulaire.html";
      });

      function resolvePostLoginTarget(userId) {
        return isRecapPending(userId) ? "resultats.html" : "actions.html";
      }

      function isRecapPending(userId) {
        if (!userId) return false;
        const map = safeParse(localStorage.getItem(RECAP_PENDING_KEY)) || {};
        return Boolean(map?.[userId]);
      }

      function findMatchingProfile(key) {
        if (!key) return null;
        const stored = safeParse(localStorage.getItem(STORAGE_KEY_FORM)) || {};
        const index = loadNameIndex();
        const targetId = index?.[key];
        if (targetId && stored[targetId]) {
          return { id: targetId, data: stored[targetId] };
        }
        const [first, last] = key.split("::");
        for (const [id, data] of Object.entries(stored)) {
          if (matchByPersonal(data?.personal, first, last)) {
            persistNameMapping(key, id);
            return { id, data };
          }
        }
        return null;
      }

      function activateUser(match, firstName, lastName) {
        const personal = match.data.personal || {};
        const resolvedFirst = personal.firstName || personal.prenom || firstName;
        const resolvedLast = personal.lastName || personal.nom || lastName;
        const displayName =
          personal.displayName ||
          personal.fullName ||
          `${resolvedFirst} ${resolvedLast}`.trim() ||
          "Profil";

        const activeUser = { id: match.id, displayName };
        if (resolvedFirst) activeUser.firstName = resolvedFirst;
        if (resolvedLast) activeUser.lastName = resolvedLast;
        localStorage.setItem(STORAGE_KEY_ACTIVE_USER, JSON.stringify(activeUser));
      }

      function setPendingName(payload) {
        try {
          localStorage.setItem(PENDING_NAME_KEY, JSON.stringify(payload));
        } catch (_error) {
          // ignore storage issues
        }
      }

      function cleanupPendingName() {
        localStorage.removeItem(PENDING_NAME_KEY);
      }

      function loadNameIndex() {
        return safeParse(localStorage.getItem(NAME_INDEX_KEY)) || {};
      }

      function persistNameMapping(key, userId) {
        if (!key || !userId) return;
        try {
          const index = loadNameIndex();
          if (index[key] === userId) return;
          index[key] = userId;
          localStorage.setItem(NAME_INDEX_KEY, JSON.stringify(index));
        } catch (_error) {
          // ignore storage issues
        }
      }

      function matchByPersonal(personal = {}, first, last) {
        if (!first || !last) return false;
        const firstCandidate = normalizeName(personal.firstName || personal.prenom);
        const lastCandidate = normalizeName(personal.lastName || personal.nom);
        if (firstCandidate && lastCandidate) {
          if (first === firstCandidate && last === lastCandidate) return true;
          if (first === lastCandidate && last === firstCandidate) return true;
        }
        const displayName = normalizeName(personal.displayName || personal.fullName);
        if (displayName) {
          const composed = `${first} ${last}`;
          if (displayName === composed || displayName === `${last} ${first}`) {
            return true;
          }
          const parts = displayName.split(/\s+/).filter(Boolean);
          if (parts.length >= 2) {
            const head = normalizeName(parts[0]);
            const tail = normalizeName(parts[parts.length - 1]);
            if ((first === head && last === tail) || (first === tail && last === head)) {
              return true;
            }
          }
        }
        return false;
      }

      function createNameKey(first, last) {
        return [`${normalizeName(first)}`, `${normalizeName(last)}`].join("::");
      }

      function normalizeName(value) {
        return String(value || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim()
          .toLowerCase();
      }

      function generateUserId() {
        if (crypto?.randomUUID) return crypto.randomUUID();
        return `user-${Date.now()}-${Math.floor(Math.random() * 1e6)}`;
      }

      function safeParse(value) {
        if (!value) return null;
        try {
          return JSON.parse(value);
        } catch (_error) {
          return null;
        }
      }
    })();
  </script>
  <script src="/dev-reload.js" defer></script>
</body>
</html>
