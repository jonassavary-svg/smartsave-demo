<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SmartSave ‚Äì Mon profil</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="theme-polish.css" />
  </head>
  <body class="profile-page app-page" data-page="profil">
    <div class="dashboard-shell app-shell">
      <header class="dashboard-header app-header">
        <div class="brand-block">
          <a class="logo" href="mon-argent.html">
            <div class="logo-mark" aria-hidden="true">S</div>
            <span class="logo-text">SmartSave</span>
          </a>
          <span class="logo-subtitle">Personal Finance</span>
        </div>
        <div class="header-search">
          <span class="header-search__icon" aria-hidden="true">üîç</span>
          <input class="header-search__input" type="search" placeholder="Rechercher" aria-label="Rechercher" />
        </div>
        <div class="header-actions">
          <div class="user-menu-wrapper">
            <button class="user-pill user-pill--account" type="button" aria-haspopup="true" aria-expanded="false">
              <span class="user-avatar user-avatar--icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-3.3 0-6 1.6-6 3.5V19h12v-1.5c0-1.9-2.7-3.5-6-3.5z"
                    fill="currentColor"
                  />
                </svg>
              </span>
              <span class="user-info">
                <span class="user-name">Mon compte</span>
              </span>
              <svg class="chevron" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
            <div class="user-menu" role="menu" aria-label="Menu Mon compte">
              <div class="user-menu__header">
                <strong data-user-name>Mon compte</strong>
              </div>
              <a class="user-menu-link" href="mes-depenses.html">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M4 6h16M4 12h16M4 18h10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
                <span>Mes d√©penses</span>
              </a>
              <button type="button" data-user-action="edit">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm8 3.5-1.9-.3a6.8 6.8 0 0 0-.7-1.7l1.1-1.6-1.4-1.4-1.6 1.1c-.5-.3-1.1-.6-1.7-.7L12 4l-1.8 1.9c-.6.1-1.2.4-1.7.7L6.9 5.5 5.5 6.9l1.1 1.6c-.3.5-.6 1.1-.7 1.7L4 12l1.9 1.8c.1.6.4 1.2.7 1.7l-1.1 1.6 1.4 1.4 1.6-1.1c.5.3 1.1.6 1.7.7L12 20l1.8-1.9c.6-.1 1.2-.4 1.7-.7l1.6 1.1 1.4-1.4-1.1-1.6c.3-.5.6-1.1.7-1.7L20 12z"
                    fill="currentColor"
                  />
                </svg>
                <span>Mon profil</span>
              </button>
              <button type="button" data-user-action="logout" class="danger">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M15 6h-2V4h2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2v-2h2a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1zM4 12l4-4v3h7v2H8v3z"
                    fill="currentColor"
                  />
                </svg>
                <span>D√©connexion</span>
              </button>
            </div>
          </div>
          <div class="hamburger-wrapper">
            <button class="icon-button menu-button" type="button" aria-label="Menu" aria-expanded="false" aria-controls="app-nav">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
            <div class="hamburger-menu" id="app-nav" role="menu" aria-label="Navigation principale">
              <a class="hamburger-link" role="menuitem" href="mon-argent.html" data-nav="home">Home</a>
              <a class="hamburger-link" role="menuitem" href="smartsave.html" data-nav="smartsave">SmartSave</a>
              <a class="hamburger-link" role="menuitem" href="actions.html" data-nav="actions">Actions</a>
              <a class="hamburger-link" role="menuitem" href="future.html" data-nav="future">Future</a>
              <a class="hamburger-link" role="menuitem" href="score.html" data-nav="score">Score</a>
            </div>
          </div>
        </div>
      </header>

      <main class="app-main profile-compact">
        <section class="profile-hero card">
          <div class="profile-hero__top">
            <div>
              <p class="section-eyebrow">Mon profil</p>
              <h1>Profil SmartSave</h1>
              <p class="profile-hero__name" data-profile-name>‚Äî</p>
            </div>
            <div class="profile-hero__badge">Donn√©es personnelles</div>
          </div>
          <div class="profile-grid" data-profile-meta></div>
          <div class="profile-hscroll" data-summary-stats></div>
        </section>

        <section class="profile-card profile-categories card" aria-label="Cat√©gories du profil">
          <div class="profile-categories__list" data-categories></div>
        </section>

        <section class="profile-card card">
          <div class="profile-card__header">
            <div>
              <p class="section-eyebrow">R√©sum√© rapide</p>
              <h2>Donn√©es essentielles</h2>
            </div>
          </div>
          <div class="profile-grid" data-profile-grid></div>
        </section>
      </main>

      <nav class="bottom-nav" aria-label="Navigation principale">
        <a class="bottom-nav__link" href="mon-argent.html" data-nav="home">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 10.5l8-6 8 6v8a1 1 0 0 1-1 1h-4v-6H9v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
          </svg>
          <span>Home</span>
        </a>
        <a class="bottom-nav__link" href="smartsave.html" data-nav="smartsave">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.8" />
            <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1.8" />
          </svg>
          <span>SmartSave</span>
        </a>
        <a class="bottom-nav__link" href="actions.html" data-nav="actions">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 6h14M5 12h14M5 18h10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
          </svg>
          <span>Actions</span>
        </a>
        <a class="bottom-nav__link" href="future.html" data-nav="future">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 16l5-5 4 3 7-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>Future</span>
        </a>
        <a class="bottom-nav__link" href="score.html" data-nav="score">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 3l2.5 5 5.5.8-4 3.9.9 5.5-4.9-2.6-4.9 2.6.9-5.5-4-3.9 5.5-.8z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
          </svg>
          <span>Score</span>
        </a>
      </nav>
    </div>

    <script>
      const STORAGE_KEY_FORM = "smartsaveFormData";
      const STORAGE_KEY_ACTIVE_USER = "smartsaveActiveUser";
      const CATEGORY_DEFINITIONS = [
        { section: "personal", label: "Informations personnelles", description: "Mon identit√© et statut", icon: "M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-3 0-6 1.5-6 3.5V19h12v-1.5c0-2-3-3.5-6-3.5z" },
        { section: "assets", label: "Mes comptes et liquidit√©s", description: "Solde et r√©serves", icon: "M4 11h16v8H4zM6 5h12v4H6z" },
        { section: "incomes", label: "Revenus", description: "Toutes mes sources de revenu", icon: "M4 12h16M4 16h10M4 8h6" },
        { section: "expenses", label: "D√©penses", description: "Charges fixes et variables", icon: "M4 6h16M4 12h16M4 18h16" },
        { section: "investments", label: "Investissements", description: "Portefeuille actif", icon: "M12 4l2.5 4.5L18 11l-3 2.5L14 18l-4-2.5L6 18l-.5-4.5L2 11l3.5-2.5z" },
        { section: "credits", label: "Cr√©dits et dettes", description: "Ce que je dois", icon: "M5 8h7v4H5zM5 14h11v4H5z" },
        { section: "taxes", label: "Imp√¥ts", description: "Informations fiscales", icon: "M5 12h6M5 16h10M5 8h10" },
        { section: "vision", label: "Vision & priorit√©s", description: "Mes objectifs financiers", icon: "M12 5l3 3-3 3-3-3zM6 12l6 7 6-7" },
      ];
      const HERO_META_FIELDS = [
        { label: "Canton", path: "personal.canton" },
        { label: "Statut pro", path: "personal.employmentStatus" },
        { label: "√âtat civil", path: "personal.maritalStatus" },
        { label: "Enfants", path: "personal.childrenCount" },
      ];
      const toNumber = (value) => {
        const parsed = Number(String(value ?? "").replace(/[^0-9.-]/g, ""));
        return Number.isFinite(parsed) ? parsed : 0;
      };
      const formatCurrency = (value) =>
        new Intl.NumberFormat("fr-CH", {
          style: "currency",
          currency: "CHF",
          maximumFractionDigits: 0,
        }).format(Number.isFinite(value) ? value : toNumber(value));
      const readStorage = (key) => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch (_error) {
          return null;
        }
      };
      const loadActiveUser = () => {
        if (typeof window.loadActiveUser === "function") return window.loadActiveUser();
        return readStorage(STORAGE_KEY_ACTIVE_USER);
      };
      const loadUserForm = (userId) => {
        if (typeof window.loadUserForm === "function") return window.loadUserForm(userId);
        const data = readStorage(STORAGE_KEY_FORM);
        if (!data) return null;
        if (userId && data[userId]) return data[userId];
        return data.__default || data;
      };
      const clearActiveUser = () => {
        try {
          localStorage.setItem(STORAGE_KEY_ACTIVE_USER, "{}");
        } catch (_error) {
          // ignore storage issues
        }
      };
      const getIncomeMonthlyAmount = (entry = {}) => {
        const amount = toNumber(entry?.amount);
        if (!amount) return 0;
        const type = String(entry?.amountType || "net").toLowerCase();
        const coefficient = type === "brut" ? 0.86 : 1;
        const hasThirteenth = entry?.thirteenth === "oui";
        const netMonthly = amount * coefficient;
        return hasThirteenth ? (netMonthly * 13) / 12 : netMonthly;
      };
      const resolveMonthlyExpenseAmount = (entry = {}) => {
        const amount = toNumber(entry?.amount);
        const frequency = String(entry?.frequency || "mensuel").toLowerCase();
        if (!amount) return 0;
        if (frequency.includes("ann")) return amount / 12;
        if (frequency.includes("trim")) return amount / 3;
        return amount;
      };
      const renderGrid = (container, fields, data) => {
        if (!container) return;
        container.innerHTML = "";
        fields.forEach((field) => {
          const raw = field.path
            .split(".")
            .reduce((acc, key) => (acc ? acc[key] : null), data);
          const value = raw || "‚Äî";
          const node = document.createElement("div");
          node.className = "profile-item";
          node.innerHTML = `<span class="profile-item__label">${field.label}</span><span class="profile-item__value">${field.format === "currency" ? formatCurrency(raw) : value}</span>`;
          container.appendChild(node);
        });
      };
      const renderHeroGrid = (container, data) => {
        if (!container) return;
        container.innerHTML = "";
        HERO_META_FIELDS.forEach((field) => {
          const raw = field.path
            .split(".")
            .reduce((acc, key) => (acc ? acc[key] : null), data);
          const value = raw || "‚Äî";
          const node = document.createElement("div");
          node.className = "profile-item";
          node.innerHTML = `<span class="profile-item__label">${field.label}</span><span class="profile-item__value">${value}</span>`;
          container.appendChild(node);
        });
      };
      const renderSummaryStats = (container, stats) => {
        if (!container) return;
        container.innerHTML = "";
        stats.forEach((stat) => {
          const card = document.createElement("div");
          card.className = "profile-stat";
          card.innerHTML = `
            <span class="profile-stat__label">${stat.label}</span>
            <span class="profile-stat__value">${formatCurrency(stat.value)}</span>
          `;
          container.appendChild(card);
        });
      };
      const renderCategories = (container) => {
        if (!container) return;
        container.innerHTML = "";
        CATEGORY_DEFINITIONS.forEach((category) => {
          const link = document.createElement("a");
          link.className = "profile-category";
          link.href = `profil-section.html?section=${category.section}`;
          link.innerHTML = `
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="${category.icon}" fill="currentColor"/></svg>
            <span>${category.label}</span>
            <span aria-hidden="true">‚ûú</span>
          `;
          container.appendChild(link);
        });
      };
      const getUserDisplayName = (activeUser = {}, formData = {}) => {
        const personal = formData.personal || {};
        return (
          activeUser.displayName ||
          personal.displayName ||
          [personal.firstName, personal.lastName].filter(Boolean).join(" ") ||
          activeUser.id ||
          "Profil"
        );
      };
      document.addEventListener("DOMContentLoaded", () => {
        const activeUser = loadActiveUser() || {};
        const formData = loadUserForm(activeUser.id) || {};
        document.querySelectorAll("[data-user-name], .user-name, [data-profile-name]").forEach((node) => {
          node.textContent = getUserDisplayName(activeUser, formData);
        });
        renderHeroGrid(document.querySelector("[data-profile-meta]"), formData);
        const incomes = Array.isArray(formData.incomes?.entries) ? formData.incomes.entries : [];
        const fixedExpenses = Array.isArray(formData.expenses?.fixed) ? formData.expenses.fixed : [];
        const variableExpenses = Array.isArray(formData.expenses?.variable) ? formData.expenses.variable : [];
        const monthlyIncome = incomes.reduce((sum, entry) => sum + Math.max(0, getIncomeMonthlyAmount(entry)), 0) + toNumber(formData.incomes?.spouseNetIncome) / 12;
        const fixed = fixedExpenses.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        const variable = variableExpenses.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        const assets = toNumber(formData.assets?.liquidAssetsTotal) || toNumber(formData.assets?.currentAccount) + toNumber(formData.assets?.savingsAccount);
        const summaryStats = [
          { label: "Revenu mensuel", value: monthlyIncome },
          { label: "Charges fixes", value: fixed },
          { label: "Charges variables", value: variable },
          { label: "Liquidit√©s", value: assets },
        ];
        renderSummaryStats(document.querySelector("[data-summary-stats]"), summaryStats);
        renderCategories(document.querySelector("[data-categories]"));
        const profileGrid = document.querySelector("[data-profile-grid]");
        profileGrid.innerHTML = "";
        const metaFields = [
          { label: "Revenu mensuel", value: monthlyIncome },
          { label: "Charges totales", value: fixed + variable },
          { label: "Valeur nette", value: toNumber(formData.credits?.assetsTotal) },
          { label: "Dettes totales", value: toNumber(formData.credits?.debtsTotal) },
        ];
        metaFields.forEach((item) => {
          const node = document.createElement("div");
          node.className = "profile-item";
          node.innerHTML = `<span class="profile-item__label">${item.label}</span><span class="profile-item__value">${formatCurrency(item.value)}</span>`;
          profileGrid.appendChild(node);
        });
        const userMenuButton = document.querySelector(".user-pill--account");
        const userMenu = document.querySelector(".user-menu");
        const hamburgerButton = document.querySelector(".menu-button");
        const hamburgerMenu = document.querySelector(".hamburger-menu");
        userMenuButton?.addEventListener("click", () => {
          const expanded = userMenuButton.getAttribute("aria-expanded") === "true";
          userMenuButton.setAttribute("aria-expanded", String(!expanded));
          userMenu?.classList.toggle("open", !expanded);
        });
        hamburgerButton?.addEventListener("click", () => {
          const expanded = hamburgerButton.getAttribute("aria-expanded") === "true";
          hamburgerButton.setAttribute("aria-expanded", String(!expanded));
          hamburgerMenu?.classList.toggle("open", !expanded);
        });
        document.addEventListener("click", (event) => {
          if (!event.target.closest(".user-menu-wrapper")) {
            userMenuButton?.setAttribute("aria-expanded", "false");
            userMenu?.classList.remove("open");
          }
          if (!event.target.closest(".hamburger-wrapper")) {
            hamburgerButton?.setAttribute("aria-expanded", "false");
            hamburgerMenu?.classList.remove("open");
          }
          const action = event.target.closest("[data-user-action]");
          if (!action) return;
          const type = action.getAttribute("data-user-action");
          if (type === "edit") {
            window.location.href = "profil.html";
          }
          if (type === "logout") {
            clearActiveUser();
            window.location.href = "index.html";
          }
        });
      });
    </script>
  </body>
</html>
