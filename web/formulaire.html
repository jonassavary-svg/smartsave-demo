<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#eef2ff">
  <script src="seed-data.js"></script>
  <meta name="google-site-verification" content="vGl2c8cgMsCaO4XbYrZAQL3l09FBO_bk6LUj6xPNgYc">
  <title>SmartSave – Formulaire</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 16px;
      line-height: 1.5;
      --bg: #f5f6f8;
      --card: #ffffff;
      --primary: #2f5aa6;
      --primary-accent: #2f5aa6;
      --text: #1f2429;
      --muted: #5a6672;
      --border-subtle: rgba(31, 36, 41, 0.12);
      --shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
      --radius-lg: 18px;
      --radius-md: 12px;
      --form-header-height: clamp(3.2rem, 6vw, 4.4rem);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .validation-banner {
      margin: 0 auto 1.2rem;
      padding: 0.9rem 1.1rem;
      max-width: 960px;
      border-radius: 12px;
      background: #fff3f3;
      border: 1px solid rgba(190, 31, 31, 0.2);
      color: #8b1a1a;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .form-page .page-header {
      position: sticky;
      top: 0;
      z-index: 60;
      padding: clamp(0.6rem, 2vw, 1rem) clamp(1rem, 3vw, 1.6rem);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 0.2rem;
      background: var(--bg);
      backdrop-filter: none;
      border-bottom: 1px solid rgba(31, 36, 41, 0.08);
    }

    .page-header__text {
      display: grid;
      gap: 0.2rem;
      text-align: center;
      max-width: clamp(230px, 50vw, 380px);
    }

    .page-header__text h1 {
      margin: 0;
      font-size: clamp(1.45rem, 3.6vw, 2rem);
      letter-spacing: -0.35px;
      font-weight: 700;
      color: var(--text);
    }

    .page-header__text p {
      margin: 0;
      font-size: clamp(0.9rem, 1.8vw, 1rem);
      color: var(--muted);
      line-height: 1.3;
    }

    .page-header__actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .form-progress {
      padding: clamp(0.7rem, 2.5vw, 1rem) clamp(1.2rem, 4vw, 2.6rem);
      display: grid;
      gap: 0.35rem;
      text-align: left;
      position: sticky;
      top: calc(var(--form-header-height) - 0.2rem);
      z-index: 75;
      background: #ffffff;
      border-bottom: 1px solid var(--border-subtle);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(14px);
    }

    .progress-label {
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .progress-track {
      position: relative;
      width: 100%;
      height: 9px;
      border-radius: 999px;
      background: #E5E7EB;
      overflow: hidden;
    }

    .progress-fill {
      position: absolute;
      inset: 0;
      width: 11%;
      border-radius: inherit;
      background: #1F3A8A;
      transition: width 0.25s ease;
    }

    #wizard-form {
      margin: 0 auto;
      padding: clamp(1rem, 4vw, 2.2rem) clamp(1rem, 4vw, 2.6rem) calc(7rem + env(safe-area-inset-bottom, 0px));
      display: grid;
      gap: clamp(1.3rem, 3vw, 2rem);
      width: min(100%, 920px);
    }

    .wizard-step {
      display: none;
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: none;
      padding: clamp(1.3rem, 4vw, 2.2rem);
      display: none;
      flex-direction: column;
      gap: clamp(1rem, 3vw, 1.4rem);
    }

    .wizard-step.active {
      display: flex;
    }

    .wizard-step h2 {
      font-size: clamp(1.35rem, 3.5vw, 1.9rem);
      font-weight: 700;
      margin: 0 0 0.35rem;
    }

    .wizard-step h3 {
      font-size: clamp(1.1rem, 3vw, 1.32rem);
      margin: 0;
    }

    .section-hint {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 0;
    }

    .input-block {
      display: grid;
      gap: 0.45rem;
    }

    .input-block span {
      font-weight: 600;
      font-size: 0.86rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .input-block input,
    .input-block select,
    .input-block textarea {
      width: 100%;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      font-size: 1rem;
      font-family: inherit;
      color: var(--text);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-block textarea {
      resize: vertical;
      min-height: 120px;
    }

    .input-block input:focus,
    .input-block select:focus,
    .input-block textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(47, 90, 166, 0.15);
    }

    input[readonly] {
      background: rgba(31, 36, 41, 0.04);
      color: var(--muted);
    }

    .grid {
      display: grid;
      gap: clamp(0.85rem, 2vw, 1.2rem);
    }
    .birth-date-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.65rem;
    }

    .grid.duo {
      grid-template-columns: 1fr;
    }

    .grid.auto-fit {
      grid-template-columns: 1fr;
    }

    .card {
      background: #ffffff;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      padding: clamp(0.9rem, 2vw, 1.3rem);
      display: grid;
      gap: clamp(0.75rem, 2vw, 1.1rem);
    }

    .lean-card {
      padding: clamp(0.75rem, 2vw, 1.05rem);
      gap: 0.75rem;
    }

    .fieldset {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      align-items: center;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 0.85rem 1rem;
    }

    .fieldset legend {
      font-weight: 600;
      font-size: 0.88rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .choice {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .choice input {
      accent-color: var(--primary);
    }

    .collection {
      display: grid;
      gap: 0.9rem;
    }

    .collection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .collection-body {
      display: grid;
      gap: 0.85rem;
    }

    .expense-sheet {
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      background: #fff;
      overflow: hidden;
    }

    .expense-sheet__header {
      display: grid;
      grid-template-columns: minmax(140px, 1.6fr) minmax(110px, 0.9fr) minmax(110px, 0.8fr) 36px;
      gap: 0.45rem;
      align-items: center;
      padding: 0.45rem 0.75rem;
      background: rgba(15, 23, 42, 0.04);
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.66rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .expense-sheet .collection-body {
      gap: 0;
    }

    .expense-row {
      display: block;
      border: 0;
      border-radius: 0;
      border-bottom: 1px solid rgba(31, 36, 41, 0.08);
      background: #fff;
      padding: 0.35rem 0.75rem;
      box-shadow: none;
    }

    .expense-row:last-child {
      border-bottom: 0;
    }

    .expense-row__grid {
      display: grid;
      grid-template-columns: minmax(140px, 1.6fr) minmax(110px, 0.9fr) minmax(110px, 0.8fr) 36px;
      gap: 0.45rem;
      align-items: center;
    }

    .expense-row input,
    .expense-row select {
      width: 100%;
      min-height: 34px;
      border-radius: 9px;
      border: 1px solid rgba(31, 36, 41, 0.16);
      padding: 0.38rem 0.6rem;
      font-size: 0.84rem;
      background: #fff;
    }

    .expense-row input:focus,
    .expense-row select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(47, 90, 166, 0.15);
    }

    .expense-row .remove-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      font-size: 1.1rem;
      box-shadow: none;
      border: 1px solid rgba(31, 36, 41, 0.12);
    }

    .expense-subtotal {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      padding: 0.55rem 0.15rem 0.1rem;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.8rem;
    }

    .expense-subtotal strong {
      color: #334155;
      font-weight: 600;
    }

    .expense-grand-total {
      margin-top: 0.9rem;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.14);
      background: rgba(15, 23, 42, 0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.96rem;
      font-weight: 800;
      color: #0f172a;
    }

    .wizard-step[data-step="3"] .collection-header {
      font-size: 0.78rem;
    }

    .wizard-step[data-step="3"] .collection-header .ghost-btn {
      font-size: 0.84rem;
      padding: 0.45rem 0.9rem;
    }

    .allocation-context {
      background: linear-gradient(135deg, #eff6ff, #f8fafc);
      border-color: rgba(37, 99, 235, 0.22);
    }

    .section-eyebrow {
      margin: 0;
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #475569;
      font-weight: 700;
    }

    .allocation-context__amount {
      font-size: clamp(1.7rem, 4vw, 2.3rem);
      font-weight: 800;
      color: #0f172a;
      margin: 0.1rem 0;
    }

    .allocation-leisure__controls {
      display: grid;
      gap: 0.7rem;
    }

    .allocation-leisure__controls input[type="range"] {
      width: 100%;
      accent-color: #2563eb;
    }

    .allocation-leisure__input span {
      font-size: 0.74rem;
    }

    .allocation-projects-live {
      margin-top: 0.4rem;
      padding: 0.7rem 0.85rem;
      border-radius: 12px;
      background: #ecfdf5;
      color: #065f46;
      font-weight: 700;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      align-items: baseline;
    }

    .allocation-projects-live strong {
      font-size: 1.08rem;
      color: #047857;
    }

    .allocation-projects-live.is-highlight {
      animation: budgetPulse 260ms ease;
    }

    @keyframes budgetPulse {
      0% { transform: scale(1); }
      45% { transform: scale(1.015); }
      100% { transform: scale(1); }
    }

    .allocation-goal-grid {
      display: grid;
      gap: 0.55rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .allocation-goal {
      border: 1px solid rgba(31, 36, 41, 0.14);
      background: #fff;
      border-radius: 12px;
      padding: 0.65rem 0.7rem;
      text-align: left;
      font-size: 0.87rem;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
    }

    .allocation-goal.is-active {
      border-color: rgba(37, 99, 235, 0.4);
      background: #eff6ff;
      color: #1d4ed8;
    }

    .allocation-goal-config {
      margin-top: 0.8rem;
      border-top: 1px solid rgba(31, 36, 41, 0.1);
      padding-top: 0.75rem;
      display: grid;
      gap: 0.55rem;
    }

    .allocation-goal-row {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      align-items: end;
    }

    .allocation-horizon-picker__controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.3rem;
    }

    .allocation-horizon-picker__controls span {
      min-width: 56px;
      text-align: center;
      font-weight: 700;
      color: #0f172a;
      font-size: 0.84rem;
    }

    .allocation-goals--compact {
      gap: 0.75rem;
    }

    .allocation-goals--compact .fieldset {
      margin: 0;
      padding: 0.65rem 0.75rem;
    }

    .allocation-goals--compact .fieldset legend {
      font-size: 0.8rem;
      letter-spacing: 0.03em;
      text-transform: none;
    }

    .allocation-goal-config[hidden] {
      display: none !important;
    }

    .allocation-goal-config__years span {
      font-size: 0.74rem;
    }

    .allocation-goal-result p {
      margin: 0;
      color: #475569;
      font-size: 0.82rem;
    }

    .allocation-goal-result strong {
      font-size: 0.98rem;
      color: #0f172a;
    }

    .allocation-goal-feedback {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 700;
      color: #166534;
    }

    .allocation-goal-feedback.is-warning {
      color: #b45309;
    }

    .allocation-goal-proposals {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .allocation-summary__row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 0.35rem 0;
      border-top: 1px dashed rgba(31, 36, 41, 0.1);
    }

    .allocation-summary__row:first-of-type {
      border-top: 0;
    }

    .collection-row {
      display: grid;
      gap: 0.75rem;
      padding: 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: #fff;
      box-shadow: none;
    }

    .collection-row.tight {
      padding: 0.8rem;
      gap: 0.6rem;
    }

    .row-grid,
    .mini-grid {
      display: grid;
      gap: 0.65rem;
    }

    .row-actions {
      display: flex;
      justify-content: flex-end;
    }

    .ghost-btn,
    .cta {
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      transition: transform 0.15s ease, filter 0.2s ease;
    }

    .ghost-btn {
      padding: 0.55rem 1.2rem;
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--primary);
    }

    .ghost-btn.small {
      padding: 0.45rem 1rem;
      font-size: 0.88rem;
    }

    .ghost-btn:hover,
    .ghost-btn:focus-visible {
      filter: brightness(0.95);
      outline: none;
    }

    .add-income-btn {
      border: 1px solid #1d4ed8;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 0.01em;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.28);
    }

    .add-income-btn:hover,
    .add-income-btn:focus-visible {
      filter: brightness(1.04);
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(29, 78, 216, 0.34);
    }

    .remove-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(31, 36, 41, 0.08);
      background: rgba(255, 255, 255, 0.95);
      color: rgba(15, 23, 42, 0.8);
      font-size: 1.4rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .remove-btn:hover,
    .remove-btn:focus-visible {
      background: rgba(15, 23, 42, 0.08);
      color: var(--primary);
      outline: none;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      border-color: transparent;
    }

    .remove-btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .cta {
      padding: 0.85rem 1.6rem;
      background: var(--primary);
      color: #fff;
      box-shadow: none;
    }

    .cta:disabled,
    .ghost-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    .fixed-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 40;
      background: var(--bg);
      backdrop-filter: none;
      border-top: 1px solid var(--border-subtle);
      padding: 0.75rem clamp(1rem, 4vw, 2.5rem);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }

    @media (max-width: 640px) {
      .fixed-nav {
        bottom: 12px;
      }
    }

    .fixed-nav button {
      width: 100%;
      min-height: 52px;
      border-radius: 999px;
    }

    .fixed-nav .ghost-btn {
      border: 1px solid rgba(31, 36, 41, 0.12);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text);
    }

    .fixed-nav .ghost-btn:focus-visible,
    .fixed-nav .ghost-btn:hover {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
    }

    .fixed-nav .cta {
      min-height: 52px;
      border-radius: 999px;
    }

    @media (min-width: 640px) {
      .fixed-nav {
        flex-direction: row;
        align-items: stretch;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .fixed-nav button {
        width: auto;
        flex: 1;
      }

      .fixed-nav .ghost-btn,
      .fixed-nav .cta {
        min-height: 56px;
      }

      .fixed-nav .ghost-btn {
        flex: 0.9;
      }

      .fixed-nav .cta {
        flex: 1.1;
      }
    }

    @media (max-width: 640px) {
      .fixed-nav {
        padding: 0.65rem clamp(0.9rem, 3vw, 1.4rem);
        gap: 0.35rem;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .fixed-nav button {
        min-height: 46px;
        border-radius: 14px;
        font-size: 0.9rem;
        width: calc(50% - 0.2rem);
      }
      .fixed-nav .ghost-btn {
        order: 1;
      }
      .fixed-nav .cta {
        order: 2;
      }

      .add-income-btn {
        width: 100%;
      }

      .expense-sheet__header {
        grid-template-columns: minmax(120px, 1.4fr) minmax(88px, 0.8fr) minmax(88px, 0.8fr) 30px;
        gap: 0.35rem;
        padding: 0.42rem 0.5rem;
        font-size: 0.62rem;
      }

      .expense-row {
        padding: 0.28rem 0.5rem;
      }

      .expense-row__grid {
        grid-template-columns: minmax(120px, 1.4fr) minmax(88px, 0.8fr) minmax(88px, 0.8fr) 30px;
        gap: 0.35rem;
      }

      .expense-row input,
      .expense-row select {
        min-height: 32px;
        font-size: 0.8rem;
        padding: 0.32rem 0.48rem;
      }

      .allocation-goal-row--short,
      .allocation-goal-row--long {
        grid-template-columns: 1.3fr 1fr 1fr;
        gap: 0.4rem;
      }

      .allocation-goal-row--short .input-block,
      .allocation-goal-row--long .input-block {
        gap: 0.25rem;
      }

      .allocation-goal-row--short .input-block span,
      .allocation-goal-row--long .input-block span {
        font-size: 0.64rem;
        letter-spacing: 0.02em;
      }

      .allocation-goal-row--short select,
      .allocation-goal-row--short input,
      .allocation-goal-row--long select,
      .allocation-goal-row--long input {
        min-height: 30px;
        padding: 0.28rem 0.4rem;
        font-size: 0.78rem;
      }

      .allocation-goal-row--short .ghost-btn.small,
      .allocation-goal-row--long .ghost-btn.small {
        min-width: 28px;
        padding: 0.2rem 0.35rem;
        font-size: 0.8rem;
      }
    }

    @media (min-width: 720px) {
      .grid.duo {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid.auto-fit {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .row-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .mini-grid {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .form-page .page-header {
        gap: clamp(0.35rem, 1vw, 0.75rem);
      }

      .page-header__text {
        text-align: center;
      }
    }

    @media (min-width: 960px) {
      .wizard-step {
        padding: clamp(1.6rem, 2.8vw, 2.6rem);
      }

      #wizard-form {
        padding-left: clamp(2rem, 4vw, 3.2rem);
        padding-right: clamp(2rem, 4vw, 3.2rem);
      }

      .collection-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem 1.4rem;
      }
    }
  
</style>
</head>
<body class="form-page">
  <header class="page-header">
    <div class="page-header__text">
      <h1>Formulaire</h1>
      <p>Complète ton profil financier SmartSave</p>
    </div>
  </header>

  <section class="form-progress" aria-live="polite">
    <div class="progress-label" id="progress-label">Étape 1 / 10</div>
    <div class="progress-track" role="progressbar" aria-valuemin="1" aria-valuemax="10" aria-valuenow="1">
      <div class="progress-fill" id="progress-fill" style="width: 11%;"></div>
    </div>
  </section>

  <form id="wizard-form" novalidate>
    <div id="validation-banner" class="validation-banner" hidden>
      Merci de remplir les champs obligatoires pour continuer.
    </div>
    <section class="wizard-step active" data-step="1">
      <h2>Informations personnelles</h2>
      <div class="grid auto-fit">
      <div class="birth-date-grid">
        <label class="input-block">
          <span>Jour</span>
          <select id="birth-day" name="birthDay" required aria-label="Jour de naissance">
            <option value="">JJ</option>
          </select>
        </label>
        <label class="input-block">
          <span>Mois</span>
          <select id="birth-month" name="birthMonth" required aria-label="Mois de naissance">
            <option value="">MM</option>
          </select>
        </label>
        <label class="input-block">
          <span>Année</span>
          <select id="birth-year" name="birthYear" required aria-label="Année de naissance">
            <option value="">AAAA</option>
          </select>
        </label>
      </div>
      <input type="hidden" name="birthDate" aria-hidden="true">
        <label class="input-block">
          <span>Canton</span>
          <select name="canton" required>
            <option value="">Sélectionner</option>
            <option value="AG">Argovie</option>
            <option value="AI">Appenzell Rhodes-Intérieures</option>
            <option value="AR">Appenzell Rhodes-Extérieures</option>
            <option value="BE">Berne</option>
            <option value="BL">Bâle-Campagne</option>
            <option value="BS">Bâle-Ville</option>
            <option value="FR">Fribourg</option>
            <option value="GE">Genève</option>
            <option value="GL">Glaris</option>
            <option value="GR">Grisons</option>
            <option value="JU">Jura</option>
            <option value="LU">Lucerne</option>
            <option value="NE">Neuchâtel</option>
            <option value="NW">Nidwald</option>
            <option value="OW">Obwald</option>
            <option value="SG">Saint-Gall</option>
            <option value="SH">Schaffhouse</option>
            <option value="SO">Soleure</option>
            <option value="SZ">Schwytz</option>
            <option value="TG">Thurgovie</option>
            <option value="TI">Tessin</option>
            <option value="UR">Uri</option>
            <option value="VD">Vaud</option>
            <option value="VS">Valais</option>
            <option value="ZG">Zoug</option>
            <option value="ZH">Zurich</option>
          </select>
        </label>
        <label class="input-block">
          <span>État civil</span>
          <select name="maritalStatus" required>
            <option value="">Sélectionner</option>
            <option value="celibataire">Célibataire</option>
            <option value="marie">Marié·e</option>
            <option value="partenariat">Partenariat enregistré</option>
            <option value="divorce">Divorcé·e</option>
            <option value="veuf">Veuf·ve</option>
          </select>
        </label>
        <label class="input-block">
          <span>Nombre d'enfants</span>
          <input type="number" name="childrenCount" min="0" value="0" required>
        </label>
        <label class="input-block">
          <span>Statut professionnel</span>
          <select name="employmentStatus" required>
            <option value="">Sélectionner</option>
            <option value="employe">Employé·e</option>
            <option value="independant">Indépendant·e</option>
            <option value="fonctionnaire">Fonctionnaire</option>
            <option value="etudiant">Étudiant·e</option>
            <option value="retraite">Retraité·e</option>
            <option value="sans_emploi">Sans emploi</option>
            <option value="autre">Autre</option>
          </select>
        </label>
        <label class="input-block">
          <span>Stabilité du revenu</span>
          <select name="incomeStability" required>
            <option value="">Sélectionner</option>
            <option value="stable">Stable</option>
            <option value="variable">Variable</option>
          </select>
        </label>
        <label class="input-block">
          <span>Affiliation religieuse</span>
          <select name="religion" required>
            <option value="">Sélectionner</option>
            <option value="catholique">Catholique</option>
            <option value="protestant">Protestant</option>
            <option value="autre">Autre</option>
            <option value="aucune">Aucune</option>
          </select>
        </label>
      </div>
    </section>

    <section class="wizard-step" data-step="2">
      <h2>Revenus</h2>
      <p class="section-hint">Déclarez vos différentes sources de revenus réguliers.</p>
      <div class="collection">
        <div class="collection-header">
          <button type="button" class="ghost-btn add-income-btn" data-action="add-income">+ Ajouter un revenu</button>
        </div>
        <div class="collection-body" id="income-list"></div>
      </div>
      <div class="card" data-conditional="spouse-income" hidden>
        <h3>Revenus du conjoint</h3>
        <label class="input-block">
          <span>Revenu net annuel (CHF)</span>
          <input type="number" name="spouseNetIncome" min="0" step="0.05" placeholder="ex. 65000">
        </label>
      </div>
    </section>

    <section class="wizard-step" data-step="3">
      <h2>Dépenses</h2>
      <div class="collection">
        <div class="collection-header">
          <span>Dépenses fixes</span>
          <button type="button" class="ghost-btn" data-action="add-fixed-expense">+ Ajouter une dépense</button>
        </div>
        <div class="expense-sheet">
          <div class="expense-sheet__header">
            <span>Dépense</span>
            <span>Fréquence</span>
            <span>Montant</span>
            <span></span>
          </div>
          <div class="collection-body" id="fixed-expense-list"></div>
        </div>
        <div class="expense-subtotal">
          <span>Sous-total (mensuel)</span>
          <strong id="fixed-expense-subtotal">CHF 0</strong>
        </div>
      </div>
      <div class="collection">
        <div class="collection-header">
          <span>Dépenses obligatoires</span>
          <button type="button" class="ghost-btn" data-action="add-variable-expense">+ Ajouter une dépense</button>
        </div>
        <div class="expense-sheet">
          <div class="expense-sheet__header">
            <span>Dépense</span>
            <span>Fréquence</span>
            <span>Montant</span>
            <span></span>
          </div>
          <div class="collection-body" id="variable-expense-list"></div>
        </div>
        <div class="expense-subtotal">
          <span>Sous-total (mensuel)</span>
          <strong id="variable-expense-subtotal">CHF 0</strong>
        </div>
      </div>
      <div class="expense-grand-total">
        <span>Total des dépenses (mensuel)</span>
        <strong id="expense-grand-total">CHF 0</strong>
      </div>
    </section>

    <section class="wizard-step" data-step="4">
      <h2>Reste à vivre</h2>

      <div class="card allocation-context">
        <p class="section-eyebrow">Ce qu’il te reste chaque mois</p>
        <div class="allocation-context__amount" data-budget-remaining>CHF 0</div>
        <p class="section-hint">
          (calculé après ton revenu net et tes dépenses essentielles, sans inclure le 13ᵉ salaire)
        </p>
      </div>

      <div class="card allocation-leisure">
        <h3>Profiter maintenant</h3>
        <p class="section-hint">
          Sur ce montant, combien veux-tu utiliser pour tes loisirs, sorties et petits extras ce mois-ci ?
        </p>
        <div class="allocation-leisure__controls">
          <input type="range" min="0" max="0" step="10" value="0" data-leisure-slider />
          <label class="input-block allocation-leisure__input">
            <span>Loisirs (CHF / mois)</span>
            <input type="number" min="0" step="10" value="0" data-leisure-input />
          </label>
        </div>
        <p class="section-hint">Tu pourras modifier ce montant chaque mois.</p>
        <div class="allocation-projects-live" data-projects-live>
          Montant disponible pour tes projets :
          <strong data-projects-available>CHF 0</strong>
          <span>/ mois</span>
        </div>
      </div>

    </section>

    <section class="wizard-step" data-step="5">
      <h2>Tes objectifs</h2>

      <div class="card allocation-context">
        <p class="section-eyebrow">Montant restant à répartir</p>
        <div class="allocation-context__amount" data-projects-budget>CHF 0</div>
        <p class="section-hint">Tu peux utiliser ce montant pour tes objectifs et construire ton avenir.</p>
      </div>

      <div class="card allocation-goals allocation-goals--compact">
        <fieldset class="fieldset">
          <legend>Objectifs court terme (facultatif) - As-tu une dépense importante à prévoir prochainement ?</legend>
          <label class="choice">
            <input type="radio" name="shortTermEnabled" value="non" checked>
            <span>Non</span>
          </label>
          <label class="choice">
            <input type="radio" name="shortTermEnabled" value="oui">
            <span>Oui</span>
          </label>
        </fieldset>

        <div class="allocation-goal-config" data-short-term-config hidden>
          <div class="allocation-goal-row allocation-goal-row--short">
            <label class="input-block">
              <span>Type de projet</span>
              <select data-short-type>
                <option value="vacances">Vacances</option>
                <option value="cadeaux">Cadeaux</option>
                <option value="voiture">Voiture</option>
                <option value="mariage">Mariage</option>
                <option value="autre">Autre</option>
              </select>
            </label>
            <div class="input-block allocation-horizon-picker">
              <span>Horizon (1 à 3 ans)</span>
              <div class="allocation-horizon-picker__controls">
                <button type="button" class="ghost-btn small" data-short-horizon-dec aria-label="Réduire l'horizon">−</button>
                <span data-short-horizon-value>1 an</span>
                <button type="button" class="ghost-btn small" data-short-horizon-inc aria-label="Augmenter l'horizon">+</button>
              </div>
            </div>
            <label class="input-block">
              <span>Montant (CHF)</span>
              <input type="number" min="0" step="100" value="0" data-short-amount>
            </label>
          </div>
          <p class="allocation-goal-feedback" data-short-feedback>
            Tu dois mettre CHF 0/mois de côté pour atteindre cet objectif.
          </p>
        </div>
      </div>

      <div class="card allocation-goals allocation-goals--compact">
        <fieldset class="fieldset">
          <legend>Objectifs long terme (facultatif) - As-tu une priorité pour l'avenir ?</legend>
          <label class="choice">
            <input type="radio" name="longTermEnabled" value="non" checked>
            <span>Non</span>
          </label>
          <label class="choice">
            <input type="radio" name="longTermEnabled" value="oui">
            <span>Oui</span>
          </label>
        </fieldset>

        <div class="allocation-goal-config" data-long-term-config hidden>
          <div class="allocation-goal-row allocation-goal-row--long">
            <label class="input-block">
              <span>Priorité</span>
              <select data-long-type>
                <option value="security">Sécurité financière</option>
                <option value="home">Achat immobilier</option>
                <option value="invest">Investissement long terme</option>
                <option value="children">Épargne pour enfants</option>
                <option value="retirement">Retraite</option>
              </select>
            </label>
            <div class="input-block allocation-horizon-picker">
              <span>Horizon (3 à 30 ans)</span>
              <div class="allocation-horizon-picker__controls">
                <button type="button" class="ghost-btn small" data-long-horizon-dec aria-label="Réduire l'horizon long terme">−</button>
                <span data-long-horizon-value>10 ans</span>
                <button type="button" class="ghost-btn small" data-long-horizon-inc aria-label="Augmenter l'horizon long terme">+</button>
              </div>
            </div>
            <label class="input-block">
              <span>Montant (CHF)</span>
              <input type="number" min="0" step="100" value="0" data-long-amount>
            </label>
          </div>
          <p class="allocation-goal-feedback" data-long-feedback>
            Tu dois mettre CHF 0/mois de côté pour atteindre cet objectif.
          </p>
        </div>
      </div>

      <div class="card allocation-summary">
        <h3>Résumé mensuel</h3>
        <div class="allocation-summary__row">
          <span>Loisirs</span>
          <strong data-summary-leisure>CHF 0</strong>
        </div>
        <div class="allocation-summary__row">
          <span>Court terme</span>
          <strong data-summary-short>CHF 0</strong>
        </div>
        <div class="allocation-summary__row">
          <span>Long terme</span>
          <strong data-summary-long>CHF 0</strong>
        </div>
        <div class="allocation-summary__row">
          <span>Reste projets</span>
          <strong data-summary-projects>CHF 0</strong>
        </div>
      </div>
    </section>

    <section class="wizard-step" data-step="6">
      <h2>Informations fiscales</h2>
      <fieldset class="fieldset">
        <legend>Payez-vous des impôts ?</legend>
        <label class="choice">
          <input type="radio" name="paysTaxes" value="oui" required>
          <span>Oui</span>
        </label>
        <label class="choice">
          <input type="radio" name="paysTaxes" value="non" required>
          <span>Non</span>
        </label>
      </fieldset>

      <div class="card" data-conditional="taxes">
        <div class="grid auto-fit">
          <label class="input-block">
            <span>Distance domicile-travail (km aller simple)</span>
            <input type="number" name="commuteDistance" min="0" step="0.1">
          </label>
          <label class="input-block">
            <span>Moyen de transport</span>
            <select name="transportMode">
              <option value="">Sélectionner</option>
              <option value="voiture">Voiture</option>
              <option value="transport_public">Transports publics</option>
              <option value="velo">Vélo</option>
              <option value="marche">Marche</option>
              <option value="mixte">Mixte</option>
            </select>
          </label>
          <label class="input-block">
            <span>Repas pris à l'extérieur</span>
            <select name="mealsFrequency">
              <option value="">Sélectionner</option>
              <option value="jamais">Jamais</option>
              <option value="un">1 jour / semaine</option>
              <option value="deux">2 jours / semaine</option>
              <option value="trois">3 jours / semaine</option>
              <option value="quatre">4 jours / semaine</option>
              <option value="cinq">5 jours / semaine</option>
            </select>
          </label>
          <label class="input-block">
            <span>Coût assurance maladie de base (CHF / an)</span>
            <input type="number" name="basicInsurance" min="0" step="0.05">
          </label>
          <label class="input-block" data-conditional="childcare">
            <span>Frais de garde d'enfants (CHF / mois)</span>
            <input type="number" name="childcareCosts" min="0" step="0.05">
          </label>
        </div>
      </div>
    </section>

    <section class="wizard-step" data-step="7">
      <h2>Comptes et avoirs</h2>
      <p class="section-hint">Cette étape nous permet de savoir quelles réserves vous avez déjà.</p>
      <div class="card">
        <h3>Comptes bancaires</h3>
        <label class="input-block">
          <span>Solde actuel sur votre compte courant (CHF)</span>
          <input type="number" name="currentAccount" min="0" step="0.05" placeholder="ex. 3000" required>
        </label>
        <label class="input-block">
          <span>Solde actuel sur votre compte épargne (CHF)</span>
          <input type="number" name="savingsAccount" min="0" step="0.05" placeholder="ex. 12000">
        </label>
        <fieldset class="fieldset">
          <legend>Versement programmé mensuel sur l’épargne ?</legend>
          <label class="choice">
            <input type="radio" name="savingsContribution" value="oui">
            <span>Oui</span>
          </label>
          <label class="choice">
            <input type="radio" name="savingsContribution" value="non">
            <span>Non</span>
          </label>
        </fieldset>
        <label class="input-block" data-conditional="savings-contrib">
          <span>Montant du versement mensuel (CHF)</span>
          <input type="number" name="savingsContributionAmount" min="0" step="0.05">
        </label>
        <label class="input-block">
          <span>Accès à votre épargne</span>
          <select name="savingsAccess">
            <option value="">Sélectionner</option>
            <option value="immediat">Immédiat</option>
            <option value="sous_3_jours">Sous 1 à 3 jours</option>
            <option value="bloque_partiel">Bloqué partiellement (préavis)</option>
            <option value="bloque_long">Bloqué plusieurs mois</option>
          </select>
        </label>
      </div>

      <div class="card">
        <h3>Épargne retraite / 3ᵉ pilier</h3>
        <fieldset class="fieldset">
          <legend>Avez-vous déjà un 3ᵉ pilier ?</legend>
          <label class="choice">
            <input type="radio" name="thirdPillar" value="oui">
            <span>Oui</span>
          </label>
          <label class="choice">
            <input type="radio" name="thirdPillar" value="non">
            <span>Non</span>
          </label>
        </fieldset>
        <div data-conditional="third-pillar">
          <label class="input-block">
            <span>Montant total du 3ᵉ pilier (CHF)</span>
            <input type="number" name="thirdPillarAmount" min="0" step="0.05">
          </label>
          <label class="input-block">
            <span>Type de 3ᵉ pilier</span>
            <select name="thirdPillarType">
              <option value="">Sélectionner</option>
              <option value="a">3ᵉ pilier A (bloqué)</option>
              <option value="b">3ᵉ pilier B (flexible)</option>
              <option value="unknown">Je ne sais pas</option>
            </select>
          </label>
        </div>
      </div>

      <div class="card lean-card">
        <div class="collection" data-collection="other-assets">
          <div class="collection-header">
            <span>Autres avoirs</span>
            <button type="button" class="ghost-btn small" data-action="add-other-asset">+ Ajouter un compte</button>
          </div>
          <div class="collection-body compact" id="other-assets-list"></div>
        </div>
      </div>

      <div class="card">
        <label class="input-block">
          <span>Total de vos avoirs disponibles (CHF)</span>
          <input type="number" name="liquidAssetsTotal" readonly>
        </label>
        <p class="section-hint">Les montants indiqués ici seront utilisés pour calculer votre réserve de sécurité et pour savoir combien vous pouvez investir sans risque.</p>
      </div>
    </section>

    <section class="wizard-step" data-step="8">
      <h2>Investissements</h2>
      <fieldset class="fieldset">
        <legend>Avez-vous déjà des investissements ?</legend>
        <label class="choice">
          <input type="radio" name="hasInvestments" value="oui">
          <span>Oui</span>
        </label>
        <label class="choice">
          <input type="radio" name="hasInvestments" value="non">
          <span>Non</span>
        </label>
      </fieldset>

      <div class="card" data-conditional="investments">
        <div class="collection">
          <div class="collection-header">
            <span>Portefeuille actuel</span>
            <button type="button" class="ghost-btn" data-action="add-investment">+ Ajouter un investissement</button>
          </div>
          <div class="collection-body" id="investment-list"></div>
        </div>
        <label class="input-block">
          <span>Commentaires / comptes externes</span>
          <textarea name="investmentNotes" rows="3" placeholder="Précisez les plateformes ou services externes (optionnel)"></textarea>
        </label>
      </div>

      <p class="section-hint" data-conditional="no-investments" hidden>
        OK, on proposera un plan d’investissement adapté à votre situation. Vous pourrez le modifier plus tard.
      </p>
    </section>

    <section class="wizard-step" data-step="9">
      <h2>Crédits et patrimoine</h2>
      <h3>Vos crédits et dettes</h3>
      <div class="collection">
        <div class="collection-header">
          <span>Crédits en cours</span>
          <button type="button" class="ghost-btn" data-action="add-credit">+ Ajouter un crédit</button>
        </div>
        <div class="collection-body" id="credit-list"></div>
      </div>

      <h3>Patrimoine immobilier / autres actifs</h3>
      <fieldset class="fieldset">
        <legend>Êtes-vous propriétaire ?</legend>
        <label class="choice">
          <input type="radio" name="isOwner" value="oui">
          <span>Oui</span>
        </label>
        <label class="choice">
          <input type="radio" name="isOwner" value="non">
          <span>Non</span>
        </label>
      </fieldset>
      <div data-conditional="owner">
        <label class="input-block">
          <span>Valeur estimée du bien (CHF)</span>
          <input type="number" name="propertyValue" min="0" step="0.05">
        </label>
        <label class="input-block">
          <span>Hypothèque actuelle (CHF)</span>
          <input type="number" name="mortgageBalance" min="0" step="0.05">
        </label>
        <label class="input-block">
          <span>Taux d’intérêt hypothécaire (%)</span>
          <input type="number" name="mortgageRate" min="0" max="20" step="0.01">
        </label>
      </div>

      <fieldset class="fieldset">
        <legend>Avez-vous des véhicules ?</legend>
        <label class="choice">
          <input type="radio" name="hasVehicles" value="oui">
          <span>Oui</span>
        </label>
        <label class="choice">
          <input type="radio" name="hasVehicles" value="non">
          <span>Non</span>
        </label>
      </fieldset>
      <div data-conditional="vehicles">
        <label class="input-block">
          <span>Valeur estimée totale (CHF)</span>
          <input type="number" name="vehicleValue" min="0" step="0.05">
        </label>
      </div>

      <div class="grid auto-fit">
        <label class="input-block">
          <span>Total des dettes (CHF)</span>
          <input type="number" name="debtsTotal" readonly>
        </label>
        <label class="input-block">
          <span>Total du patrimoine déclaré (CHF)</span>
          <input type="number" name="assetsTotal" readonly>
        </label>
      </div>
    </section>

    <section class="wizard-step" data-step="10">
      <h2>Votre vision face à l’avenir</h2>
      <p class="section-hint">
        Décrivez brièvement votre priorité financière et votre appétence au risque pour que SmartSave adapte sa proposition.
      </p>
      <label class="input-block">
        <span>Priorité principale</span>
        <select name="primaryPriority" required>
          <option value="">Sélectionner</option>
          <option value="securite">Sécurité</option>
          <option value="projet">Projet spécial</option>
          <option value="croissance">Croissance</option>
        </select>
      </label>
      <label class="input-block">
        <span>Tolérance au risque</span>
        <select name="riskTolerance" required>
          <option value="">Sélectionner</option>
          <option value="faible">Faible</option>
          <option value="moyenne">Moyenne</option>
          <option value="elevee">Élevée</option>
        </select>
      </label>
    </section>

    <div class="fixed-nav">
      <button type="button" class="ghost-btn" id="prev-btn">⬅ Précédent</button>
      <button type="button" class="cta" id="next-btn">Suivant ➡</button>
    </div>
  </form>

  <script src="runtimeConfig.js?v=20260212-01"></script>
  <script>
    const STORAGE_KEY_FORM = "smartsaveFormData";
    const STORAGE_KEY_ACTIVE_USER = "smartsaveActiveUser";
    const RECAP_PENDING_KEY = "smartsaveRecapPendingByUser";
    const NAME_INDEX_KEY = "smartsaveNameIndex";
    const PENDING_NAME_KEY = "smartsavePendingName";
    const SYNC_ENABLED = true;
    const SYNC_URL = "http://localhost:3000";
    const SYNC_URL_OVERRIDE_KEY = "smartsaveProfileSyncUrl";

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("wizard-form");
      if (!form) return;

      const birthDaySelect = form.querySelector("#birth-day");
      const birthMonthSelect = form.querySelector("#birth-month");
      const birthYearSelect = form.querySelector("#birth-year");
      const birthDateInput = form.querySelector('input[name="birthDate"]');

      const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

      function padTwo(value) {
        return String(value).padStart(2, "0");
      }

      function updateBirthDateValueFromSelects() {
        if (!birthDateInput || !birthDaySelect || !birthMonthSelect || !birthYearSelect) return;
        const day = birthDaySelect.value;
        const month = birthMonthSelect.value;
        const year = birthYearSelect.value;
        if (!day || !month || !year) {
          birthDateInput.value = "";
          return;
        }
        birthDateInput.value = `${year}-${padTwo(month)}-${padTwo(day)}`;
      }

      function syncBirthSelectsFromIso(value) {
        if (!birthDaySelect || !birthMonthSelect || !birthYearSelect) return;
        if (!value) {
          birthDaySelect.value = "";
          birthMonthSelect.value = "";
          birthYearSelect.value = "";
          return;
        }
        const parts = value.split("-");
        if (parts.length !== 3) return;
        const [year, month, day] = parts;
        birthYearSelect.value = year || "";
        birthMonthSelect.value = month || "";
        birthDaySelect.value = day || "";
      }

      function populateBirthDateOptions() {
        if (!birthDaySelect || !birthMonthSelect || !birthYearSelect) return;
        for (let day = 1; day <= 31; day += 1) {
          const option = document.createElement("option");
          option.value = padTwo(day);
          option.textContent = padTwo(day);
          birthDaySelect.appendChild(option);
        }
        monthNames.forEach((label, index) => {
          const option = document.createElement("option");
          option.value = padTwo(index + 1);
          option.textContent = label;
          birthMonthSelect.appendChild(option);
        });
        const currentYear = new Date().getFullYear();
        for (let year = currentYear - 16; year >= currentYear - 100; year -= 1) {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = String(year);
          birthYearSelect.appendChild(option);
        }
      }

      populateBirthDateOptions();
      [birthDaySelect, birthMonthSelect, birthYearSelect].forEach((select) => {
        select?.addEventListener("change", updateBirthDateValueFromSelects);
      });
      updateBirthDateValueFromSelects();
      const steps = Array.from(form.querySelectorAll(".wizard-step"));
      const totalSteps = steps.length;
      const progressFill = document.getElementById("progress-fill");
      const progressLabel = document.getElementById("progress-label");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const backDashboardBtn = document.querySelector('[data-action="back-dashboard"]');

      const collections = {
        incomes: document.getElementById("income-list"),
        fixedExpenses: document.getElementById("fixed-expense-list"),
        variableExpenses: document.getElementById("variable-expense-list"),
        otherAssets: document.getElementById("other-assets-list"),
        investments: document.getElementById("investment-list"),
        credits: document.getElementById("credit-list"),
      };

      const SHORT_TERM_LABELS = {
        vacances: "Vacances",
        cadeaux: "Cadeaux",
        voiture: "Voiture",
        mariage: "Mariage",
        autre: "Autre",
      };

      const LONG_TERM_LABELS = {
        security: "Sécurité financière",
        home: "Achat immobilier",
        invest: "Investissement long terme",
        children: "Épargne pour enfants",
        retirement: "Retraite",
      };

      const LONG_TERM_DEFAULT_TARGETS = {
        security: 12000,
        home: 80000,
        invest: 30000,
        children: 20000,
        retirement: 150000,
      };

      const allocationNodes = {
        remainingAmount: document.querySelector("[data-budget-remaining]"),
        leisureSlider: document.querySelector("[data-leisure-slider]"),
        leisureInput: document.querySelector("[data-leisure-input]"),
        projectsLive: document.querySelector("[data-projects-live]"),
        projectsAvailable: document.querySelector("[data-projects-available]"),
        projectsBudget: document.querySelector("[data-projects-budget]"),
        summaryLeisure: document.querySelector("[data-summary-leisure]"),
        summaryShort: document.querySelector("[data-summary-short]"),
        summaryLong: document.querySelector("[data-summary-long]"),
        summaryProjects: document.querySelector("[data-summary-projects]"),
        shortTermConfig: document.querySelector("[data-short-term-config]"),
        shortType: document.querySelector("[data-short-type]"),
        shortHorizonDec: document.querySelector("[data-short-horizon-dec]"),
        shortHorizonInc: document.querySelector("[data-short-horizon-inc]"),
        shortHorizonValue: document.querySelector("[data-short-horizon-value]"),
        shortAmount: document.querySelector("[data-short-amount]"),
        shortRequired: document.querySelector("[data-short-required]"),
        shortFeedback: document.querySelector("[data-short-feedback]"),
        longTermConfig: document.querySelector("[data-long-term-config]"),
        longType: document.querySelector("[data-long-type]"),
        longHorizonDec: document.querySelector("[data-long-horizon-dec]"),
        longHorizonInc: document.querySelector("[data-long-horizon-inc]"),
        longHorizonValue: document.querySelector("[data-long-horizon-value]"),
        longAmount: document.querySelector("[data-long-amount]"),
        longFeedback: document.querySelector("[data-long-feedback]"),
      };

      const isPartnered = (status) => ["marie", "partenariat"].includes(status);

      let currentStepIndex = 0;
      const activeUserId = getActiveUserId();
      let formState = loadFormState(activeUserId);
      const pendingName = getPendingName();
      injectPendingName(formState, pendingName, activeUserId);
      injectActiveUserIdentity(formState, activeUserId);
      ensureProfileIdentity(formState, activeUserId);
      setupAllocationInteractions();

      initialiseCollections();
      restoreForm();
      updateFixedExpenseSubtotal();
      updateVariableExpenseSubtotal();
      refreshAllocationStep();
      updateUI();

      if (backDashboardBtn) {
        backDashboardBtn.addEventListener("click", () => {
          window.location.href = "mon-argent.html";
        });
      }

      prevBtn.addEventListener("click", () => {
        if (currentStepIndex === 0) return;
        persistCurrentStep();
        currentStepIndex -= 1;
        updateUI();
      });

      nextBtn.addEventListener("click", async () => {
        if (!persistCurrentStep(currentStepIndex === totalSteps - 1)) return;

        if (currentStepIndex === totalSteps - 1) {
          const resolvedUserId = resolveSessionUserId(activeUserId, formState);
          ensureActiveUserSession(resolvedUserId, formState);
          injectPendingName(formState, pendingName, resolvedUserId);
          saveFormState(resolvedUserId, formState);
          // Do not block navigation on network sync.
          syncCompletedProfile(resolvedUserId, formState).catch(() => {});
          registerPendingName(resolvedUserId, pendingName);
          markRecapPendingOnFirstCompletion(resolvedUserId);
          window.location.href = resolvePostOnboardingTarget(resolvedUserId);
          return;
        }

        currentStepIndex += 1;
        updateUI();
      });

      form.addEventListener("input", (event) => {
        const target = event.target;
        const { name } = target;

        if (["currentAccount", "savingsAccount", "thirdPillarAmount", "thirdPillarType"].includes(name) || target.closest("#other-assets-list")) {
          updateLiquidAssetsTotal();
        }

        if (name === "childrenCount") {
          toggleChildcareQuestion();
        }

        if (["propertyValue", "mortgageBalance", "vehicleValue"].includes(name) || target.closest("#credit-list")) {
          updateDebtAssetTotals();
        }

        if (target.closest("#fixed-expense-list")) {
          updateFixedExpenseSubtotal();
        }
        if (target.closest("#variable-expense-list")) {
          updateVariableExpenseSubtotal();
        }
      });

      form.addEventListener("change", (event) => {
        const target = event.target;
        const { name, value } = target;

        if (name === "paysTaxes") {
          toggleTaxDetails(value === "oui");
        }

        if (name === "savingsContribution") {
          toggleSavingsContribution(value === "oui");
          updateLiquidAssetsTotal();
        }

        if (name === "thirdPillar") {
          toggleThirdPillar(value === "oui");
          updateLiquidAssetsTotal();
        }

        if (name === "thirdPillarType") {
          updateLiquidAssetsTotal();
        }

        if (name === "hasInvestments") {
          toggleInvestments(value === "oui");
        }

        if (name === "maritalStatus") {
          toggleSpouseIncome(isPartnered(value));
        }

        if (target.closest("#other-assets-list")) {
          updateLiquidAssetsTotal();
        }

        if (target.closest("#fixed-expense-list")) {
          updateFixedExpenseSubtotal();
        }
        if (target.closest("#variable-expense-list")) {
          updateVariableExpenseSubtotal();
        }

        if (name === "isOwner") {
          toggleOwnerFields(value === "oui");
          updateDebtAssetTotals();
        }

        if (name === "hasVehicles") {
          toggleVehicleFields(value === "oui");
          updateDebtAssetTotals();
        }
      });

      toggleTaxDetails(getRadioValue("paysTaxes") === "oui");
      toggleSavingsContribution(getRadioValue("savingsContribution") === "oui");
      toggleThirdPillar(getRadioValue("thirdPillar") === "oui");
      toggleInvestments(getRadioValue("hasInvestments") === "oui");
      toggleOwnerFields(getRadioValue("isOwner") === "oui");
      toggleVehicleFields(getRadioValue("hasVehicles") === "oui");
      toggleSpouseIncome(isPartnered(getInputValue("maritalStatus")));
      toggleChildcareQuestion();
      updateLiquidAssetsTotal();
      updateDebtAssetTotals();

      function updateUI() {
        steps.forEach((step, index) => {
          step.classList.toggle("active", index === currentStepIndex);
        });

        const isFinalStep = currentStepIndex === totalSteps - 1;
        prevBtn.hidden = false;
        prevBtn.disabled = currentStepIndex === 0;
        nextBtn.textContent = isFinalStep ? "Calculer mon score" : "Suivant ➡";

        const progress = ((currentStepIndex + 1) / totalSteps) * 100;
        progressFill.style.width = `${progress}%`;
        progressFill.parentElement?.setAttribute("aria-valuenow", String(currentStepIndex + 1));
        progressLabel.textContent = `Étape ${currentStepIndex + 1} / ${totalSteps}`;

        toggleSpouseIncome(isPartnered(getInputValue("maritalStatus")));
        if (currentStepIndex === 3 || currentStepIndex === 4) {
          refreshAllocationStep();
        }
      }

      function persistCurrentStep(force = false) {
        const currentStep = steps[currentStepIndex];
        if (!validateStep(currentStep)) return false;
        saveStepData(currentStep.dataset.step);
        ensureProfileIdentity(formState, activeUserId);
        if (force) {
          steps.forEach((step) => saveStepData(step.dataset.step));
        }
        ensureProfileIdentity(formState, activeUserId);
        saveFormState(activeUserId, formState);
        return true;
      }

      function initialiseCollections() {
        if (!Array.isArray(formState.expenses.fixed)) {
          formState.expenses.fixed = defaultFixedExpenseEntries();
        }
        if (!Array.isArray(formState.expenses.variable)) {
          formState.expenses.variable = defaultVariableExpenseEntries();
        } else if (!formState.expenses.variable.length) {
          formState.expenses.variable = defaultVariableExpenseEntries();
        }
        if (!formState.assets.otherAssets || !formState.assets.otherAssets.length) formState.assets.otherAssets = [defaultOtherAssetEntry()];
        if (!formState.investments.items.length) formState.investments.items.push(defaultInvestmentEntry());

        renderCollection(collections.incomes, formState.incomes.entries, createIncomeRow);
        renderCollection(collections.fixedExpenses, formState.expenses.fixed, (entry) => createExpenseRow("fixe", entry));
        renderCollection(collections.variableExpenses, formState.expenses.variable, (entry) => createExpenseRow("variable", entry));
        renderCollection(collections.otherAssets, formState.assets.otherAssets, createOtherAssetRow);
        renderCollection(collections.investments, formState.investments.items, createInvestmentRow);
        renderCollection(collections.credits, formState.credits.loans, createCreditRow);

        form.querySelector('[data-action="add-income"]').addEventListener("click", () => {
          const entry = defaultIncomeEntry();
          formState.incomes.entries.push(entry);
          collections.incomes.appendChild(createIncomeRow(entry));
        });

        form.querySelector('[data-action="add-fixed-expense"]').addEventListener("click", () => {
          const entry = defaultExpenseEntry("fixe");
          formState.expenses.fixed.push(entry);
          collections.fixedExpenses.appendChild(createExpenseRow("fixe", entry));
          updateFixedExpenseSubtotal();
        });

        const addVariableExpenseBtn = form.querySelector('[data-action="add-variable-expense"]');
        if (addVariableExpenseBtn) {
          addVariableExpenseBtn.addEventListener("click", () => {
            const entry = defaultExpenseEntry("variable");
            formState.expenses.variable.push(entry);
            collections.variableExpenses.appendChild(createExpenseRow("variable", entry));
            updateVariableExpenseSubtotal();
          });
        }

        const addOtherAssetBtn = form.querySelector('[data-action="add-other-asset"]');
        if (addOtherAssetBtn) {
          addOtherAssetBtn.addEventListener("click", () => {
            const entry = defaultOtherAssetEntry();
            formState.assets.otherAssets.push(entry);
            if (collections.otherAssets) {
              collections.otherAssets.appendChild(createOtherAssetRow(entry));
            }
            updateLiquidAssetsTotal();
          });
        }

        form.querySelector('[data-action="add-investment"]').addEventListener("click", () => {
          const entry = defaultInvestmentEntry();
          formState.investments.items.push(entry);
          collections.investments.appendChild(createInvestmentRow(entry));
        });

        form.querySelector('[data-action="add-credit"]').addEventListener("click", () => {
          const entry = defaultCreditEntry();
          formState.credits.loans.push(entry);
          collections.credits.appendChild(createCreditRow(entry));
          updateDebtAssetTotals();
        });
      }

      function setupAllocationInteractions() {
        const slider = allocationNodes.leisureSlider;
        const input = allocationNodes.leisureInput;
        const shortType = allocationNodes.shortType;
        const shortHorizonDec = allocationNodes.shortHorizonDec;
        const shortHorizonInc = allocationNodes.shortHorizonInc;
        const shortAmount = allocationNodes.shortAmount;
        const longType = allocationNodes.longType;
        const longHorizonDec = allocationNodes.longHorizonDec;
        const longHorizonInc = allocationNodes.longHorizonInc;
        const longAmount = allocationNodes.longAmount;
        if (slider) {
          slider.addEventListener("input", () => {
            setAllocationLeisure(toNumber(slider.value));
          });
        }
        if (input) {
          input.addEventListener("input", () => {
            setAllocationLeisure(toNumber(input.value));
          });
        }
        form.querySelectorAll('input[name="shortTermEnabled"]').forEach((radio) => {
          radio.addEventListener("change", () => {
            const plan = getAllocationPlan();
            plan.shortTerm.enabled = getRadioValue("shortTermEnabled") === "oui";
            syncAllocationControls();
            updateAllocationOutputs();
          });
        });
        form.querySelectorAll('input[name="longTermEnabled"]').forEach((radio) => {
          radio.addEventListener("change", () => {
            const plan = getAllocationPlan();
            plan.longTerm.enabled = getRadioValue("longTermEnabled") === "oui";
            syncAllocationControls();
            updateAllocationOutputs();
          });
        });
        if (shortType) {
          shortType.addEventListener("change", () => {
            const plan = getAllocationPlan();
            plan.shortTerm.type = shortType.value || "vacances";
            syncAllocationControls();
            updateAllocationOutputs();
          });
        }
        if (shortHorizonDec) {
          shortHorizonDec.addEventListener("click", () => {
            setShortTermHorizon(getAllocationPlan().shortTerm.horizonYears - 1);
          });
        }
        if (shortHorizonInc) {
          shortHorizonInc.addEventListener("click", () => {
            setShortTermHorizon(getAllocationPlan().shortTerm.horizonYears + 1);
          });
        }
        if (shortAmount) {
          shortAmount.addEventListener("input", () => {
            getAllocationPlan().shortTerm.amount = Math.max(0, toNumber(shortAmount.value));
            updateAllocationOutputs();
          });
        }
        if (longType) {
          longType.addEventListener("change", () => {
            const plan = getAllocationPlan();
            plan.longTerm.type = longType.value || "security";
            plan.longTerm.amount = toNumber(LONG_TERM_DEFAULT_TARGETS[plan.longTerm.type] || 0);
            syncAllocationControls();
            updateAllocationOutputs();
          });
        }
        if (longHorizonDec) {
          longHorizonDec.addEventListener("click", () => {
            setLongTermHorizon(getAllocationPlan().longTerm.horizonYears - 1);
          });
        }
        if (longHorizonInc) {
          longHorizonInc.addEventListener("click", () => {
            setLongTermHorizon(getAllocationPlan().longTerm.horizonYears + 1);
          });
        }
        if (longAmount) {
          longAmount.addEventListener("input", () => {
            getAllocationPlan().longTerm.amount = Math.max(0, toNumber(longAmount.value));
            updateAllocationOutputs();
          });
        }
      }

      function getAllocationPlan() {
        const current = formState?.allocationPlan;
        if (!current || typeof current !== "object") {
          formState.allocationPlan = {
            leisureMonthly: 0,
            shortTerm: {
              enabled: false,
              type: "vacances",
              horizonYears: 1,
              amount: 0,
            },
            longTerm: {
              enabled: false,
              type: "security",
              horizonYears: 10,
              amount: 12000,
            },
            goalMode: "horizon",
          };
        }
        const plan = formState.allocationPlan;
        plan.leisureMonthly = Math.max(0, toNumber(plan.leisureMonthly));
        if (!plan.shortTerm || typeof plan.shortTerm !== "object") {
          plan.shortTerm = { enabled: false, type: "vacances", horizonYears: 1, amount: 0 };
        }
        if (!plan.longTerm || typeof plan.longTerm !== "object") {
          plan.longTerm = { enabled: false, type: "security", horizonYears: 10, amount: 12000 };
        }
        plan.shortTerm.enabled = Boolean(plan.shortTerm.enabled);
        plan.shortTerm.type = plan.shortTerm.type || "vacances";
        plan.shortTerm.horizonYears = Math.min(3, Math.max(1, toInteger(plan.shortTerm.horizonYears || 1)));
        plan.shortTerm.amount = Math.max(0, toNumber(plan.shortTerm.amount || 0));
        plan.longTerm.enabled = Boolean(plan.longTerm.enabled);
        plan.longTerm.type = plan.longTerm.type || "security";
        plan.longTerm.horizonYears = Math.min(30, Math.max(3, toInteger(plan.longTerm.horizonYears || 10)));
        plan.longTerm.amount = Math.max(
          0,
          toNumber(plan.longTerm.amount || LONG_TERM_DEFAULT_TARGETS[plan.longTerm.type] || 0)
        );
        plan.goalMode = "horizon";
        return plan;
      }

      function computeMonthlyIncomeNetWithoutThirteenth() {
        const entries = Array.isArray(formState?.incomes?.entries) ? formState.incomes.entries : [];
        return entries.reduce((sum, entry) => {
          const type = String(entry?.amountType || "").toLowerCase();
          if (type !== "net") return sum;
          return sum + toNumber(entry?.amount);
        }, 0);
      }

      function computeEssentialExpensesMonthly() {
        const fixed = Array.isArray(formState?.expenses?.fixed) ? formState.expenses.fixed : [];
        const variable = Array.isArray(formState?.expenses?.variable) ? formState.expenses.variable : [];
        const fixedTotal = fixed.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        const variableTotal = variable.reduce((sum, entry) => sum + resolveMonthlyExpenseAmount(entry), 0);
        return fixedTotal + variableTotal;
      }

      function computeRemainingMonthlyBudget() {
        return Math.max(0, computeMonthlyIncomeNetWithoutThirteenth() - computeEssentialExpensesMonthly());
      }

      function getProjectsBudget() {
        const plan = getAllocationPlan();
        const remaining = computeRemainingMonthlyBudget();
        return Math.max(0, remaining - plan.leisureMonthly);
      }

      function setAllocationLeisure(value) {
        const plan = getAllocationPlan();
        const remaining = computeRemainingMonthlyBudget();
        const next = Math.max(0, Math.min(remaining, Math.round(toNumber(value))));
        plan.leisureMonthly = next;
        syncAllocationControls();
        updateAllocationOutputs(true);
      }

      function setShortTermHorizon(years) {
        const plan = getAllocationPlan();
        plan.shortTerm.horizonYears = Math.min(3, Math.max(1, toInteger(years)));
        syncAllocationControls();
        updateAllocationOutputs();
      }

      function setLongTermHorizon(years) {
        const plan = getAllocationPlan();
        plan.longTerm.horizonYears = Math.min(30, Math.max(3, toInteger(years)));
        syncAllocationControls();
        updateAllocationOutputs();
      }

      function syncAllocationControls() {
        const plan = getAllocationPlan();
        const remaining = computeRemainingMonthlyBudget();
        const slider = allocationNodes.leisureSlider;
        const input = allocationNodes.leisureInput;
        const shortHorizonValue = allocationNodes.shortHorizonValue;
        const shortAmount = allocationNodes.shortAmount;
        const shortType = allocationNodes.shortType;
        const longHorizonValue = allocationNodes.longHorizonValue;
        const longAmount = allocationNodes.longAmount;
        const longType = allocationNodes.longType;
        if (slider) {
          slider.max = String(Math.round(remaining));
          slider.value = String(Math.min(Math.round(remaining), Math.round(plan.leisureMonthly)));
        }
        if (input) {
          input.max = String(Math.round(remaining));
          input.value = String(Math.min(Math.round(remaining), Math.round(plan.leisureMonthly)));
        }
        const shortEnabled = plan.shortTerm.enabled;
        const longEnabled = plan.longTerm.enabled;
        if (allocationNodes.shortTermConfig) allocationNodes.shortTermConfig.hidden = !shortEnabled;
        if (allocationNodes.longTermConfig) allocationNodes.longTermConfig.hidden = !longEnabled;
        const shortYes = form.querySelector('input[name="shortTermEnabled"][value="oui"]');
        const shortNo = form.querySelector('input[name="shortTermEnabled"][value="non"]');
        const longYes = form.querySelector('input[name="longTermEnabled"][value="oui"]');
        const longNo = form.querySelector('input[name="longTermEnabled"][value="non"]');
        if (shortYes) shortYes.checked = shortEnabled;
        if (shortNo) shortNo.checked = !shortEnabled;
        if (longYes) longYes.checked = longEnabled;
        if (longNo) longNo.checked = !longEnabled;
        if (shortType) shortType.value = plan.shortTerm.type;
        if (shortHorizonValue) {
          shortHorizonValue.textContent = `${plan.shortTerm.horizonYears} ${plan.shortTerm.horizonYears > 1 ? "ans" : "an"}`;
        }
        if (shortAmount) shortAmount.value = String(Math.round(plan.shortTerm.amount));
        if (longType) longType.value = plan.longTerm.type;
        if (longHorizonValue) {
          longHorizonValue.textContent = `${plan.longTerm.horizonYears} ${plan.longTerm.horizonYears > 1 ? "ans" : "an"}`;
        }
        if (longAmount) longAmount.value = String(Math.round(plan.longTerm.amount));
      }

      function computeShortTermMonthly() {
        const plan = getAllocationPlan();
        if (!plan.shortTerm.enabled) return 0;
        const years = Math.max(1, plan.shortTerm.horizonYears);
        return plan.shortTerm.amount / (years * 12);
      }

      function computeLongTermMonthly() {
        const plan = getAllocationPlan();
        if (!plan.longTerm.enabled) return 0;
        const years = Math.max(3, plan.longTerm.horizonYears);
        return plan.longTerm.amount / (years * 12);
      }

      function updateGoalComputation(projectsBudgetBeforeShortTerm) {
        const plan = getAllocationPlan();
        const shortMonthly = computeShortTermMonthly();
        const availableAfterShortTerm = Math.max(0, projectsBudgetBeforeShortTerm - shortMonthly);
        if (allocationNodes.shortRequired) {
          allocationNodes.shortRequired.textContent = `${formatCurrency(shortMonthly)} / mois`;
        }
        if (allocationNodes.shortFeedback) {
          const label =
            SHORT_TERM_LABELS[plan.shortTerm.type] || "ce projet";
          allocationNodes.shortFeedback.textContent = `Tu dois mettre ${formatCurrency(
            shortMonthly
          )}/mois de côté pour atteindre ${label}.`;
        }
        const longMonthly = computeLongTermMonthly();
        if (allocationNodes.longFeedback) {
          const label = LONG_TERM_LABELS[plan.longTerm.type] || "ton objectif long terme";
          if (!plan.longTerm.enabled) {
            allocationNodes.longFeedback.textContent = "Aucun objectif long terme sélectionné.";
            allocationNodes.longFeedback.classList.remove("is-warning");
          } else if (availableAfterShortTerm >= longMonthly) {
            allocationNodes.longFeedback.textContent = `Tu dois mettre ${formatCurrency(
              longMonthly
            )}/mois de côté pour atteindre ${label}.`;
            allocationNodes.longFeedback.classList.remove("is-warning");
          } else if (availableAfterShortTerm > 0) {
            allocationNodes.longFeedback.textContent = `Tu dois mettre ${formatCurrency(
              longMonthly
            )}/mois de côté pour atteindre ${label}.`;
            allocationNodes.longFeedback.classList.add("is-warning");
          } else {
            allocationNodes.longFeedback.textContent = `Tu dois mettre ${formatCurrency(
              longMonthly
            )}/mois de côté pour atteindre ${label}.`;
            allocationNodes.longFeedback.classList.add("is-warning");
          }
        }
      }

      function updateAllocationOutputs(animate = false) {
        const plan = getAllocationPlan();
        const remaining = computeRemainingMonthlyBudget();
        const projectsBudgetBeforeShortTerm = Math.max(0, remaining - plan.leisureMonthly);
        const shortMonthly = computeShortTermMonthly();
        const longMonthly = computeLongTermMonthly();
        const projectsBudgetAfterShort = Math.max(0, projectsBudgetBeforeShortTerm - shortMonthly);
        const projectsBudget = Math.max(0, projectsBudgetAfterShort - longMonthly);
        if (allocationNodes.remainingAmount) {
          allocationNodes.remainingAmount.textContent = formatCurrency(remaining);
        }
        if (allocationNodes.projectsAvailable) {
          allocationNodes.projectsAvailable.textContent = formatCurrency(projectsBudgetBeforeShortTerm);
        }
        if (allocationNodes.projectsBudget) {
          allocationNodes.projectsBudget.textContent = formatCurrency(projectsBudgetBeforeShortTerm);
        }
        if (allocationNodes.summaryLeisure) {
          allocationNodes.summaryLeisure.textContent = formatCurrency(plan.leisureMonthly);
        }
        if (allocationNodes.summaryShort) {
          allocationNodes.summaryShort.textContent = formatCurrency(shortMonthly);
        }
        if (allocationNodes.summaryLong) {
          allocationNodes.summaryLong.textContent = formatCurrency(longMonthly);
        }
        if (allocationNodes.summaryProjects) {
          allocationNodes.summaryProjects.textContent = formatCurrency(projectsBudget);
        }
        if (allocationNodes.projectsLive && animate) {
          allocationNodes.projectsLive.classList.remove("is-highlight");
          void allocationNodes.projectsLive.offsetWidth;
          allocationNodes.projectsLive.classList.add("is-highlight");
        }
        updateGoalComputation(projectsBudgetBeforeShortTerm);
      }

      function refreshAllocationStep() {
        const plan = getAllocationPlan();
        const remaining = computeRemainingMonthlyBudget();
        if (plan.leisureMonthly > remaining) {
          plan.leisureMonthly = remaining;
        }
        syncAllocationControls();
        updateAllocationOutputs();
      }

      function saveStepData(stepId) {
        switch (Number(stepId)) {
          case 1:
            const existingPersonal = formState.personal || {};
            formState.personal = {
              ...existingPersonal,
              birthDate: getInputValue("birthDate"),
              canton: getInputValue("canton"),
              maritalStatus: getInputValue("maritalStatus"),
              childrenCount: toInteger(getInputValue("childrenCount")),
              employmentStatus: getInputValue("employmentStatus"),
              incomeStability: getInputValue("incomeStability"),
              religion: getInputValue("religion"),
            };
            normalizePersonalIdentity(formState.personal);
            break;
          case 2:
            formState.incomes = {
              entries: Array.from(collections.incomes.querySelectorAll(".collection-row")).map((row) => ({
                sourceType: getFieldValue(row, "sourceType"),
                amount: toNumber(getFieldValue(row, "amount")),
                amountType: getFieldValue(row, "amountType"),
                thirteenth: getFieldValue(row, "thirteenth"),
              })),
              spouseNetIncome: toNumber(getInputValue("spouseNetIncome")),
            };
            break;
          case 3:
            formState.expenses = {
              fixed: mapExpenseRows(collections.fixedExpenses),
              variable: mapExpenseRows(collections.variableExpenses),
            };
            break;
          case 4:
          case 5:
            const plan = getAllocationPlan();
            formState.allocationPlan = {
              leisureMonthly: toNumber(plan.leisureMonthly),
              shortTerm: {
                enabled: Boolean(plan.shortTerm?.enabled),
                type: plan.shortTerm?.type || "vacances",
                horizonYears: Math.min(3, Math.max(1, toInteger(plan.shortTerm?.horizonYears || 1))),
                amount: Math.max(0, toNumber(plan.shortTerm?.amount || 0)),
              },
              longTerm: {
                enabled: Boolean(plan.longTerm?.enabled),
                type: plan.longTerm?.type || "security",
                horizonYears: Math.min(30, Math.max(3, toInteger(plan.longTerm?.horizonYears || 10))),
                amount: Math.max(0, toNumber(plan.longTerm?.amount || 0)),
              },
              goalMode: "horizon",
            };
            formState.exceptional = {
              type: "aucune",
              amount: 0,
              notes: "",
            };
            break;
          case 6:
            formState.taxes = {
              paysTaxes: getRadioValue("paysTaxes"),
              commuteDistance: toNumber(getInputValue("commuteDistance")),
              transportMode: getInputValue("transportMode"),
              mealsFrequency: getInputValue("mealsFrequency"),
              basicInsurance: toNumber(getInputValue("basicInsurance")),
              childcareCosts: toNumber(getInputValue("childcareCosts")),
            };
            break;
          case 7:
            const mappedOtherAssets = mapOtherAssetRows(collections.otherAssets);
            formState.assets = {
              currentAccount: toNumber(getInputValue("currentAccount")),
              savingsAccount: toNumber(getInputValue("savingsAccount")),
              savingsContribution: getRadioValue("savingsContribution"),
              savingsContributionAmount: toNumber(getInputValue("savingsContributionAmount")),
              savingsAccess: getInputValue("savingsAccess"),
              thirdPillar: getRadioValue("thirdPillar"),
              thirdPillarAmount: toNumber(getInputValue("thirdPillarAmount")),
              thirdPillarType: getInputValue("thirdPillarType"),
              otherAssets: mappedOtherAssets.length ? mappedOtherAssets : [defaultOtherAssetEntry()],
              liquidAssetsTotal: toNumber(getInputValue("liquidAssetsTotal")),
            };
            break;
          case 8:
            formState.investments = {
              hasInvestments: getRadioValue("hasInvestments"),
              items:
                getRadioValue("hasInvestments") === "oui"
                  ? Array.from(collections.investments.querySelectorAll(".collection-row")).map((row) => ({
                      investmentType: getFieldValue(row, "investmentType"),
                      amount: toNumber(getFieldValue(row, "amount")),
                      hasMonthly: getFieldValue(row, "hasMonthly"),
                      monthlyAmount: toNumber(getFieldValue(row, "monthlyAmount")),
                      horizon: getFieldValue(row, "horizon"),
                    }))
                  : [],
              notes: getInputValue("investmentNotes"),
            };
            break;
          case 9:
            formState.credits = {
              loans: Array.from(collections.credits.querySelectorAll(".collection-row")).map((row) => ({
                creditType: getFieldValue(row, "creditType"),
                outstanding: toNumber(getFieldValue(row, "outstanding")),
                monthlyPayment: toNumber(getFieldValue(row, "monthly")),
                rate: toNumber(getFieldValue(row, "rate")),
                frequency: getFieldValue(row, "frequency"),
              })),
              isOwner: getRadioValue("isOwner"),
              propertyValue: toNumber(getInputValue("propertyValue")),
              mortgageBalance: toNumber(getInputValue("mortgageBalance")),
              mortgageRate: toNumber(getInputValue("mortgageRate")),
              hasVehicles: getRadioValue("hasVehicles"),
              vehicleValue: toNumber(getInputValue("vehicleValue")),
              debtsTotal: toNumber(getInputValue("debtsTotal")),
              assetsTotal: toNumber(getInputValue("assetsTotal")),
            };
            break;
          case 10:
            formState.goals = {
              primaryPriority: getInputValue("primaryPriority"),
              riskTolerance: getInputValue("riskTolerance"),
            };
            break;
          default:
            break;
        }
      }

      function restoreForm() {
        const { personal, incomes, expenses, taxes, assets, investments, credits, goals } = formState;

        setInputValue("birthDate", personal.birthDate);
        setInputValue("canton", personal.canton);
        setInputValue("maritalStatus", personal.maritalStatus);
        setInputValue("childrenCount", String(personal.childrenCount ?? 0));
        setInputValue("employmentStatus", personal.employmentStatus);
        setInputValue("incomeStability", personal.incomeStability);
        setInputValue("religion", personal.religion);

        renderCollection(collections.incomes, incomes.entries, createIncomeRow);
        setInputValue("spouseNetIncome", toValueString(incomes.spouseNetIncome));

        renderCollection(collections.fixedExpenses, expenses.fixed, (entry) =>
          createExpenseRow("fixe", entry)
        );
        renderCollection(collections.variableExpenses, expenses.variable, (entry) =>
          createExpenseRow("variable", entry)
        );
        updateFixedExpenseSubtotal();
        updateVariableExpenseSubtotal();

        refreshAllocationStep();

        setRadioValue("paysTaxes", taxes.paysTaxes);
        setInputValue("commuteDistance", toValueString(taxes.commuteDistance));
        setInputValue("transportMode", taxes.transportMode);
        setInputValue("mealsFrequency", taxes.mealsFrequency);
        setInputValue("basicInsurance", toValueString(taxes.basicInsurance));
        setInputValue("childcareCosts", toValueString(taxes.childcareCosts));

        setInputValue("currentAccount", toValueString(assets.currentAccount));
        setInputValue("savingsAccount", toValueString(assets.savingsAccount));
        setRadioValue("savingsContribution", assets.savingsContribution);
        setInputValue("savingsContributionAmount", toValueString(assets.savingsContributionAmount));
        setInputValue("savingsAccess", assets.savingsAccess);
        setRadioValue("thirdPillar", assets.thirdPillar);
        setInputValue("thirdPillarAmount", toValueString(assets.thirdPillarAmount));
        setInputValue("thirdPillarType", assets.thirdPillarType);
        renderCollection(
          collections.otherAssets,
          assets.otherAssets && assets.otherAssets.length ? assets.otherAssets : [defaultOtherAssetEntry()],
          createOtherAssetRow
        );
        setInputValue("liquidAssetsTotal", toValueString(assets.liquidAssetsTotal));

        setRadioValue("hasInvestments", investments.hasInvestments);
        renderCollection(collections.investments, investments.items.length ? investments.items : [defaultInvestmentEntry()], createInvestmentRow);
        setInputValue("investmentNotes", investments.notes);

        renderCollection(collections.credits, credits.loans, createCreditRow);
        setRadioValue("isOwner", credits.isOwner);
        setInputValue("propertyValue", toValueString(credits.propertyValue));
        setInputValue("mortgageBalance", toValueString(credits.mortgageBalance));
        setInputValue("mortgageRate", toValueString(credits.mortgageRate));
        setRadioValue("hasVehicles", credits.hasVehicles);
        setInputValue("vehicleValue", toValueString(credits.vehicleValue));
        setInputValue("debtsTotal", toValueString(credits.debtsTotal));
        setInputValue("assetsTotal", toValueString(credits.assetsTotal));

        setInputValue("primaryPriority", goals.primaryPriority);
        setInputValue("riskTolerance", goals.riskTolerance);
      }

      function updateLiquidAssetsTotal() {
        const current = toNumber(getInputValue("currentAccount"));
        const savings = toNumber(getInputValue("savingsAccount"));
        const otherRows = collections.otherAssets
          ? Array.from(collections.otherAssets.querySelectorAll(".collection-row"))
          : [];
        const other = otherRows.reduce((acc, row) => acc + toNumber(getFieldValue(row, "amount")), 0);
        const thirdType = getInputValue("thirdPillarType");
        const thirdAmount = toNumber(getInputValue("thirdPillarAmount"));

        const includeThird = thirdType && thirdType !== "a";
        const total = current + savings + other + (includeThird ? thirdAmount : 0);
        const totalField = form.querySelector('[name="liquidAssetsTotal"]');
        if (totalField) {
          totalField.value = total ? total.toFixed(2) : "";
        }
      }

      function updateDebtAssetTotals() {
        const loans = Array.from(collections.credits.querySelectorAll(".collection-row"));
        const loanTotal = loans.reduce((acc, row) => acc + toNumber(getFieldValue(row, "outstanding")), 0);
        const mortgage = toNumber(getInputValue("mortgageBalance"));
        const propertyValue = toNumber(getInputValue("propertyValue"));
        const vehicleValue = toNumber(getInputValue("vehicleValue"));

        const totalDebt = loanTotal + mortgage;
        const totalAssets = propertyValue + vehicleValue;

        setInputValue("debtsTotal", totalDebt ? totalDebt.toFixed(2) : "");
        setInputValue("assetsTotal", totalAssets ? totalAssets.toFixed(2) : "");
      }

      function toggleTaxDetails(visible) {
        const container = form.querySelector('[data-conditional="taxes"]');
        toggleContainer(container, visible, ["commuteDistance", "transportMode", "mealsFrequency", "basicInsurance", "childcareCosts"]);
      }

      function toggleSavingsContribution(visible) {
        const container = form.querySelector('[data-conditional="savings-contrib"]');
        toggleContainer(container, visible, ["savingsContributionAmount"]);
      }

      function toggleThirdPillar(visible) {
        const container = form.querySelector('[data-conditional="third-pillar"]');
        toggleContainer(container, visible, ["thirdPillarAmount", "thirdPillarType"]);
      }

      function toggleSpouseIncome(visible) {
        const container = form.querySelector('[data-conditional="spouse-income"]');
        toggleContainer(container, visible, ["spouseNetIncome"]);
      }

      function toggleInvestments(visible) {
        const investCard = form.querySelector('[data-conditional="investments"]');
        const placeholder = form.querySelector('[data-conditional="no-investments"]');
        toggleContainer(investCard, visible, [], { preserveValues: true });
        placeholder.hidden = visible;
        investCard?.querySelectorAll("input, select, textarea").forEach((field) => {
          field.disabled = !visible;
        });
      }

      function toggleChildcareQuestion() {
        const count = toNumber(getInputValue("childrenCount"));
        const container = form.querySelector('[data-conditional="childcare"]');
        toggleContainer(container, count > 0, ["childcareCosts"]);
      }

      function toggleOwnerFields(visible) {
        const container = form.querySelector('[data-conditional="owner"]');
        toggleContainer(container, visible, ["propertyValue", "mortgageBalance", "mortgageRate"]);
      }

      function toggleVehicleFields(visible) {
        const container = form.querySelector('[data-conditional="vehicles"]');
        toggleContainer(container, visible, ["vehicleValue"]);
      }

      function toggleContainer(container, visible, fieldNames = [], options = {}) {
        if (!container) return;
        container.hidden = !visible;
        if (!container.dataset.originalDisplay || container.dataset.originalDisplay === "none") {
          let fallback = container.style.display && container.style.display !== "none" ? container.style.display : "";
          if (!fallback) {
            fallback = container.classList.contains("card") ? "grid" : "block";
          }
          container.dataset.originalDisplay = fallback;
        }
        container.style.display = visible ? container.dataset.originalDisplay : "none";
        const preserve = options.preserveValues ?? false;
        fieldNames.forEach((name) => {
          const field = Array.from(container.querySelectorAll(`[name="${name}"]`));
          field.forEach((input) => {
            input.disabled = !visible;
            if (!visible && !preserve) input.value = "";
          });
        });
      }

      function validateStep(step) {
        const banner = document.getElementById("validation-banner");
        const fields = step.querySelectorAll("input, select, textarea");
        for (const field of fields) {
          if (field.disabled || field.closest("[hidden]")) continue;
          if (!field.checkValidity()) {
            field.reportValidity();
            if (banner) {
              banner.hidden = false;
            }
            field.scrollIntoView({ behavior: "smooth", block: "center" });
            field.focus({ preventScroll: true });
            return false;
          }
        }
        if (banner) banner.hidden = true;
        return true;
      }

      function renderCollection(container, entries, factory) {
        if (!container) return;
        container.innerHTML = "";
        if (!entries || entries.length === 0) return;
        entries.forEach((entry) => container.appendChild(factory(entry)));
      }

      function createIncomeRow(data = defaultIncomeEntry()) {
        const row = document.createElement("div");
        row.className = "collection-row";
        row.innerHTML = `
          <div class="row-grid">
            <label class="input-block">
              <span>Type de revenu</span>
              <select data-field="sourceType" required>
                <option value="salaire">Salaire</option>
                <option value="bonus">Bonus</option>
                <option value="freelance">Freelance / Mandat</option>
                <option value="rente">Rente</option>
                <option value="autre">Autre</option>
              </select>
            </label>
            <label class="input-block">
              <span>Montant (CHF)</span>
              <input type="number" min="0" step="0.05" data-field="amount" required>
            </label>
            <label class="input-block">
              <span>Type</span>
              <select data-field="amountType" required>
                <option value="net">Net</option>
                <option value="brut">Brut</option>
              </select>
            </label>
            <label class="input-block">
              <span>13ᵉ salaire</span>
              <select data-field="thirteenth" required>
                <option value="oui">Oui</option>
                <option value="non">Non</option>
              </select>
            </label>
          </div>
      <div class="row-actions">
        <button type="button" class="remove-btn" data-action="remove-row" aria-label="Supprimer ce revenu">
          <span aria-hidden="true">×</span>
        </button>
      </div>
        `;
        setFieldValue(row, "sourceType", data.sourceType || "salaire");
        setFieldValue(row, "amount", toValueString(data.amount));
        setFieldValue(row, "amountType", data.amountType || "net");
        setFieldValue(row, "thirteenth", data.thirteenth || "oui");

        row.querySelector('[data-action="remove-row"]').addEventListener("click", () => {
          if (collections.incomes.children.length > 1) {
            const index = Array.from(collections.incomes.children).indexOf(row);
            formState.incomes.entries.splice(index, 1);
            row.remove();
          }
        });

      return row;
    }

    function createOtherAssetRow(data = defaultOtherAssetEntry()) {
      const row = document.createElement("div");
      row.className = "collection-row tight";
      row.innerHTML = `
        <div class="mini-grid">
          <label class="input-block">
            <span>Montant (CHF)</span>
            <input type="number" min="0" step="0.05" data-field="amount" placeholder="ex. 2000">
          </label>
          <label class="input-block">
            <span>Type d’avoir</span>
            <select data-field="type">
              <option value="">Sélectionner</option>
              <option value="cash">Cash / Liquide</option>
              <option value="compte_commun">Compte commun</option>
              <option value="compte_enfant">Compte enfant</option>
              <option value="compte_etranger">Compte étranger</option>
              <option value="autre">Autre</option>
            </select>
          </label>
          <label class="input-block">
            <span>Objectif du compte</span>
            <select data-field="purpose">
              <option value="anticipation">Anticipation &amp; projets</option>
              <option value="croissance">Croissance &amp; investissements</option>
            </select>
          </label>
          <label class="input-block">
            <span>Accès</span>
            <select data-field="access">
              <option value="">Sélectionner</option>
              <option value="immediat">Immédiat</option>
              <option value="quelques_jours">Sous quelques jours</option>
              <option value="bloque">Bloqué</option>
              <option value="interne">Total (interne)</option>
            </select>
          </label>
        </div>
        <div class="row-actions">
          <button type="button" class="remove-btn" data-action="remove-row" aria-label="Supprimer cet avoir">
            <span aria-hidden="true">×</span>
          </button>
        </div>
      `;

      setFieldValue(row, "amount", toValueString(data.amount));
      setFieldValue(row, "type", data.type || "");
      setFieldValue(row, "purpose", data.purpose || "anticipation");
      setFieldValue(row, "access", data.access || "");

      row.querySelector('[data-action="remove-row"]').addEventListener("click", () => {
        if (!collections.otherAssets) return;
        if (collections.otherAssets.children.length > 1) {
          const index = Array.from(collections.otherAssets.children).indexOf(row);
          if (index >= 0) {
            formState.assets.otherAssets.splice(index, 1);
          }
          row.remove();
        } else {
          const clearedValue = defaultOtherAssetEntry().purpose;
          row.querySelectorAll("[data-field]").forEach((input) => {
            if (input.dataset.field === "purpose") {
              input.value = clearedValue;
            } else {
              input.value = "";
            }
          });
          if (formState.assets.otherAssets.length) {
            formState.assets.otherAssets[0] = defaultOtherAssetEntry();
          } else {
            formState.assets.otherAssets.push(defaultOtherAssetEntry());
          }
        }
        updateLiquidAssetsTotal();
      });

      return row;
    }

      function createExpenseRow(kind, data = defaultExpenseEntry(kind)) {
        const row = document.createElement("div");
        row.className = "collection-row expense-row";
        row.innerHTML = `
          <div class="expense-row__grid">
            <input type="text" data-field="label" placeholder="Nom de la dépense" aria-label="Nom de la dépense" required>
            <select data-field="frequency" aria-label="Fréquence" required>
              <option value="mensuel">Mensuel</option>
              <option value="annuel">Annuel</option>
            </select>
            <input type="number" min="0" step="0.05" data-field="amount" placeholder="Montant (CHF)" aria-label="Montant en CHF" required>
            <button type="button" class="remove-btn" data-action="remove-row" aria-label="Supprimer cette dépense">
              <span aria-hidden="true">×</span>
            </button>
          </div>
        `;
        setFieldValue(row, "label", data.label || "");
        setFieldValue(row, "amount", toValueString(data.amount));
        setFieldValue(row, "frequency", data.frequency || "mensuel");

        row.querySelector('[data-action="remove-row"]').addEventListener("click", () => {
          const list = kind === "fixe" ? collections.fixedExpenses : collections.variableExpenses;
          if (!list) return;
          const index = Array.from(list.children).indexOf(row);
          if (kind === "fixe") {
            formState.expenses.fixed.splice(index, 1);
          } else {
            formState.expenses.variable.splice(index, 1);
          }
          row.remove();
          if (kind === "fixe") {
            updateFixedExpenseSubtotal();
          } else {
            updateVariableExpenseSubtotal();
          }
        });

        return row;
      }

      function createInvestmentRow(data = defaultInvestmentEntry()) {
        const row = document.createElement("div");
        row.className = "collection-row";
        row.innerHTML = `
          <div class="row-grid">
            <label class="input-block">
              <span>Type d’investissement</span>
              <select data-field="investmentType" required>
                <option value="etf">ETF</option>
                <option value="fonds">Fonds de placement</option>
                <option value="actions">Actions</option>
                <option value="obligations">Obligations</option>
                <option value="pilier3a">Comptes de prévoyance (3a bancaire)</option>
                <option value="crypto">Crypto</option>
                <option value="autre">Autre</option>
              </select>
            </label>
            <label class="input-block">
              <span>Montant actuel (CHF)</span>
              <input type="number" min="0" step="0.05" data-field="amount" required>
            </label>
            <label class="input-block">
              <span>Versement mensuel programmé ?</span>
              <select data-field="hasMonthly" required>
                <option value="non">Non</option>
                <option value="oui">Oui</option>
              </select>
            </label>
            <label class="input-block" data-field-wrapper="monthlyAmount">
              <span>Montant mensuel (CHF)</span>
              <input type="number" min="0" step="0.05" data-field="monthlyAmount">
            </label>
            <label class="input-block">
              <span>Horizon de placement</span>
              <select data-field="horizon" required>
                <option value="court">Court terme (&lt; 3 ans)</option>
                <option value="moyen">Moyen terme (3 - 7 ans)</option>
                <option value="long">Long terme (&gt; 7 ans)</option>
              </select>
            </label>
          </div>
      <div class="row-actions">
        <button type="button" class="remove-btn" data-action="remove-row" aria-label="Supprimer cet investissement">
          <span aria-hidden="true">×</span>
        </button>
      </div>
        `;

        setFieldValue(row, "investmentType", data.investmentType || "etf");
        setFieldValue(row, "amount", toValueString(data.amount));
        setFieldValue(row, "hasMonthly", data.hasMonthly || "non");
        setFieldValue(row, "monthlyAmount", toValueString(data.monthlyAmount));
        setFieldValue(row, "horizon", data.horizon || "long");

        toggleMonthlyAmount(row);

        row.querySelector('[data-field="hasMonthly"]').addEventListener("change", () => toggleMonthlyAmount(row));

        row.querySelector('[data-action="remove-row"]').addEventListener("click", () => {
          if (collections.investments.children.length > 1) {
            const index = Array.from(collections.investments.children).indexOf(row);
            formState.investments.items.splice(index, 1);
            row.remove();
          }
        });

        return row;
      }

      function createCreditRow(data = defaultCreditEntry()) {
        const row = document.createElement("div");
        row.className = "collection-row";
        row.innerHTML = `
          <div class="row-grid">
            <label class="input-block">
              <span>Type de crédit</span>
              <select data-field="creditType" required>
                <option value="consommation">Crédit à la consommation</option>
                <option value="leasing">Leasing voiture</option>
                <option value="carte_credit">Carte de crédit</option>
                <option value="hypotheque">Hypothèque</option>
                <option value="autre">Autre</option>
              </select>
            </label>
            <label class="input-block">
              <span>Montant restant à rembourser (CHF)</span>
              <input type="number" min="0" step="0.05" data-field="outstanding" required>
            </label>
            <label class="input-block">
              <span>Mensualité (CHF)</span>
              <input type="number" min="0" step="0.05" data-field="monthly" required>
            </label>
            <label class="input-block">
              <span>Taux d’intérêt (%)</span>
              <input type="number" min="0" max="100" step="0.01" data-field="rate">
            </label>
            <label class="input-block">
              <span>Fréquence de paiement</span>
              <select data-field="frequency" required>
                <option value="mensuel">Mensuel</option>
                <option value="trimestriel">Trimestriel</option>
                <option value="annuel">Annuel</option>
              </select>
            </label>
          </div>
      <div class="row-actions">
        <button type="button" class="remove-btn" data-action="remove-row" aria-label="Supprimer ce crédit">
          <span aria-hidden="true">×</span>
        </button>
      </div>
        `;

        setFieldValue(row, "creditType", data.creditType || "consommation");
        setFieldValue(row, "outstanding", toValueString(data.outstanding));
        setFieldValue(row, "monthly", toValueString(data.monthlyPayment));
        setFieldValue(row, "rate", toValueString(data.rate));
        setFieldValue(row, "frequency", data.frequency || "mensuel");

        row.querySelector('[data-action="remove-row"]').addEventListener("click", () => {
          const index = Array.from(collections.credits.children).indexOf(row);
          if (index >= 0) {
            formState.credits.loans.splice(index, 1);
            row.remove();
            updateDebtAssetTotals();
          }
        });

        return row;
      }

      function toggleMonthlyAmount(row) {
        const hasMonthly = getFieldValue(row, "hasMonthly") === "oui";
        const wrapper = row.querySelector('[data-field-wrapper="monthlyAmount"]');
        const input = row.querySelector('[data-field="monthlyAmount"]');
        if (wrapper && input) {
          wrapper.hidden = !hasMonthly;
          input.required = hasMonthly;
          if (!hasMonthly) input.value = "";
        }
      }

      function mapExpenseRows(container) {
        if (!container) return [];
        return Array.from(container.querySelectorAll(".collection-row")).map((row) => ({
          label: getFieldValue(row, "label"),
          amount: toNumber(getFieldValue(row, "amount")),
          frequency: getFieldValue(row, "frequency"),
        }));
      }

      function resolveMonthlyExpenseAmount(entry = {}) {
        const amount = toNumber(entry.amount);
        const frequency = String(entry.frequency || "mensuel").toLowerCase();
        if (!amount) return 0;
        if (frequency.includes("ann")) return amount / 12;
        return amount;
      }

      function updateFixedExpenseSubtotal() {
        const target = document.getElementById("fixed-expense-subtotal");
        if (!target) return;
        const total = mapExpenseRows(collections.fixedExpenses).reduce(
          (sum, entry) => sum + resolveMonthlyExpenseAmount(entry),
          0
        );
        target.textContent = formatCurrency(total);
        updateExpenseGrandTotal();
      }

      function updateVariableExpenseSubtotal() {
        const target = document.getElementById("variable-expense-subtotal");
        if (!target) return;
        const total = mapExpenseRows(collections.variableExpenses).reduce(
          (sum, entry) => sum + resolveMonthlyExpenseAmount(entry),
          0
        );
        target.textContent = formatCurrency(total);
        updateExpenseGrandTotal();
      }

      function updateExpenseGrandTotal() {
        const target = document.getElementById("expense-grand-total");
        if (!target) return;
        const fixedTotal = mapExpenseRows(collections.fixedExpenses).reduce(
          (sum, entry) => sum + resolveMonthlyExpenseAmount(entry),
          0
        );
        const variableTotal = mapExpenseRows(collections.variableExpenses).reduce(
          (sum, entry) => sum + resolveMonthlyExpenseAmount(entry),
          0
        );
        target.textContent = formatCurrency(fixedTotal + variableTotal);
      }

      function mapOtherAssetRows(container) {
        if (!container) return [];
        return Array.from(container.querySelectorAll(".collection-row")).map((row) => ({
          amount: toNumber(getFieldValue(row, "amount")),
          type: getFieldValue(row, "type"),
          purpose: getFieldValue(row, "purpose"),
          access: getFieldValue(row, "access"),
        }));
      }

      function getInputValue(name) {
        const field = form.querySelector(`[name="${name}"]`);
        return field && !field.disabled ? field.value || "" : "";
      }

      function setInputValue(name, value) {
        const field = form.querySelector(`[name="${name}"]`);
        if (!field) return;
        if (value === undefined || value === null) {
          field.value = "";
        } else {
          field.value = value;
        }
        if (name === "birthDate") {
          syncBirthSelectsFromIso(field.value);
        }
      }

      function getRadioValue(name) {
        const selected = form.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : "";
      }

      function setRadioValue(name, value) {
        if (!value) return;
        const radio = form.querySelector(`input[name="${name}"][value="${value}"]`);
        if (radio) {
          radio.checked = true;
          radio.dispatchEvent(new Event("change"));
        }
      }

      function getFieldValue(row, field) {
        const element = row.querySelector(`[data-field="${field}"]`);
        return element ? element.value || "" : "";
      }

      function setFieldValue(row, field, value) {
        const element = row.querySelector(`[data-field="${field}"]`);
        if (element && value !== undefined && value !== null && value !== "") {
          element.value = value;
        }
      }
    });

    function defaultFormState() {
      return {
        personal: {
          firstName: "",
          lastName: "",
          prenom: "",
          nom: "",
          displayName: "",
          fullName: "",
          birthDate: "",
          canton: "",
          maritalStatus: "",
          childrenCount: 0,
          employmentStatus: "",
          incomeStability: "",
          religion: "",
        },
        incomes: {
          entries: [],
          spouseNetIncome: 0,
        },
        expenses: {
          fixed: defaultFixedExpenseEntries(),
          variable: defaultVariableExpenseEntries(),
        },
        exceptional: {
          type: "",
          amount: 0,
          notes: "",
        },
        allocationPlan: {
          leisureMonthly: 0,
          shortTerm: {
            enabled: false,
            type: "vacances",
            horizonYears: 1,
            amount: 0,
          },
          longTerm: {
            enabled: false,
            type: "security",
            horizonYears: 10,
            amount: 12000,
          },
          goalMode: "horizon",
        },
        taxes: {
          paysTaxes: "",
          commuteDistance: 0,
          transportMode: "",
          mealsFrequency: "",
          basicInsurance: 0,
          childcareCosts: 0,
        },
        assets: {
          currentAccount: 0,
          savingsAccount: 0,
          savingsContribution: "",
          savingsContributionAmount: 0,
          savingsAccess: "",
          thirdPillar: "",
          thirdPillarAmount: 0,
          thirdPillarType: "",
          thirdPillarContribution: 0,
          thirdPillarContributionSpouse: 0,
          otherAssets: [defaultOtherAssetEntry()],
          liquidAssetsTotal: 0,
        },
        investments: {
          hasInvestments: "",
          items: [defaultInvestmentEntry()],
          notes: "",
        },
        credits: {
          loans: [],
          isOwner: "",
          propertyValue: 0,
          mortgageBalance: 0,
          mortgageRate: 0,
          hasVehicles: "",
          vehicleValue: 0,
          debtsTotal: 0,
          assetsTotal: 0,
        },
        goals: {
          primaryPriority: "",
          riskTolerance: "",
        },
      };
    }

    function defaultIncomeEntry() {
      return {
        sourceType: "salaire",
        amount: 0,
        amountType: "net",
        thirteenth: "oui",
      };
    }

    function defaultFixedExpenseEntries() {
      return [
        { label: "Loyer", amount: 0, frequency: "mensuel" },
        { label: "LAMal", amount: 0, frequency: "mensuel" },
        { label: "Assurances", amount: 0, frequency: "mensuel" },
        { label: "Impôts", amount: 0, frequency: "annuel" },
        { label: "Abonnements", amount: 0, frequency: "mensuel" },
      ];
    }

    function defaultVariableExpenseEntries() {
      return [
        { label: "Nourriture", amount: 0, frequency: "mensuel" },
        { label: "Essence", amount: 0, frequency: "mensuel" },
      ];
    }

    function defaultExpenseEntry(kind) {
      return {
        label: "",
        amount: 0,
        frequency: "mensuel",
      };
    }

    function defaultOtherAssetEntry() {
      return {
        amount: "",
        type: "",
        access: "",
        purpose: "anticipation",
      };
    }

    function defaultInvestmentEntry() {
      return {
        investmentType: "etf",
        amount: 0,
        hasMonthly: "non",
        monthlyAmount: 0,
        horizon: "long",
      };
    }

    function defaultCreditEntry() {
      return {
        creditType: "consommation",
        outstanding: 0,
        monthlyPayment: 0,
        rate: 0,
        frequency: "mensuel",
      };
    }

    function loadFormState(userId) {
      const raw = localStorage.getItem(STORAGE_KEY_FORM);
      if (!raw) return defaultFormState();
      try {
        const parsed = JSON.parse(raw);
        if (!userId) return parsed.__default ? mergeWithDefaults(parsed.__default) : defaultFormState();
        return parsed[userId] ? mergeWithDefaults(parsed[userId]) : defaultFormState();
      } catch (_error) {
        return defaultFormState();
      }
    }

      function saveFormState(userId, state) {
        const raw = localStorage.getItem(STORAGE_KEY_FORM);
        const payload = raw ? safelyParse(raw) : {};
        const nextState = JSON.parse(JSON.stringify(state || {}));
        ensureProfileIdentity(nextState, userId);
        if (userId) {
          payload[userId] = nextState;
        } else {
          payload.__default = nextState;
        }
        localStorage.setItem(STORAGE_KEY_FORM, JSON.stringify(payload));
      }

      function resolvePostOnboardingTarget(userId) {
        return isRecapPending(userId) ? "resultats.html" : "mon-argent.html";
      }

      function resolveSessionUserId(activeId, state) {
        const candidate = String(activeId || state?.profileId || state?.id || "").trim();
        return candidate;
      }

      function ensureActiveUserSession(userId, state) {
        if (!userId) return;
        const personal = state?.personal || {};
        const firstName = String(personal.firstName || personal.prenom || "").trim();
        const lastName = String(personal.lastName || personal.nom || "").trim();
        const displayName = String(
          personal.displayName || personal.fullName || [firstName, lastName].filter(Boolean).join(" ")
        ).trim();
        const payload = {
          id: userId,
          displayName: displayName || "Profil",
        };
        if (firstName) payload.firstName = firstName;
        if (lastName) payload.lastName = lastName;
        try {
          localStorage.setItem(STORAGE_KEY_ACTIVE_USER, JSON.stringify(payload));
        } catch (_error) {
          // ignore storage issues
        }
      }

      function markRecapPendingOnFirstCompletion(userId) {
        if (!userId) return;
        const map = safelyParse(localStorage.getItem(RECAP_PENDING_KEY)) || {};
        if (Object.prototype.hasOwnProperty.call(map, userId)) return;
        map[userId] = true;
        localStorage.setItem(RECAP_PENDING_KEY, JSON.stringify(map));
      }

      function isRecapPending(userId) {
        if (!userId) return false;
        const map = safelyParse(localStorage.getItem(RECAP_PENDING_KEY)) || {};
        return Boolean(map?.[userId]);
      }

    function mergeWithDefaults(partial) {
      const defaults = defaultFormState();
      const merged = deepMerge(defaults, partial);
      return normalizeState(merged);
    }

    function deepMerge(target, source) {
      if (typeof source !== "object" || source === null) return target;
      Object.keys(source).forEach((key) => {
        if (Array.isArray(source[key])) {
          target[key] = source[key];
        } else if (source[key] && typeof source[key] === "object") {
          target[key] = deepMerge(target[key] ?? {}, source[key]);
        } else {
          target[key] = source[key];
        }
      });
      return target;
    }

    function normalizeState(state) {
      if (state) {
        if (!state.incomes || typeof state.incomes !== "object") {
          state.incomes = { entries: [], spouseNetIncome: 0 };
        }
        const rawEntries = Array.isArray(state.incomes.entries)
          ? state.incomes.entries
          : state.incomes.entries
          ? [state.incomes.entries]
          : [];
        state.incomes.entries = rawEntries.filter((entry) => {
          if (!entry || typeof entry !== "object") return false;
          const sourceType = String(entry.sourceType ?? "").trim().toLowerCase();
          const amountType = String(entry.amountType ?? "").trim().toLowerCase();
          const thirteenth = String(entry.thirteenth ?? "").trim().toLowerCase();
          const amount = toNumber(entry.amount ?? 0);
          const isLegacyDefaultIncome =
            amount === 0 &&
            (sourceType === "" || sourceType === "salaire") &&
            (amountType === "" || amountType === "net") &&
            (thirteenth === "" || thirteenth === "oui");
          return !isLegacyDefaultIncome;
        });

        if (!state.expenses || typeof state.expenses !== "object") {
          state.expenses = {
            fixed: defaultFixedExpenseEntries(),
            variable: defaultVariableExpenseEntries(),
          };
        }
        const fixedEntries = Array.isArray(state.expenses.fixed)
          ? state.expenses.fixed
          : state.expenses.fixed
          ? [state.expenses.fixed]
          : defaultFixedExpenseEntries();
        const isLegacySingleDefaultFixed =
          fixedEntries.length === 1 &&
          String(fixedEntries[0]?.label || "").trim().toLowerCase() === "loyer" &&
          toNumber(fixedEntries[0]?.amount) === 0 &&
          String(fixedEntries[0]?.frequency || "mensuel").trim().toLowerCase() === "mensuel";
        state.expenses.fixed = fixedEntries;
        if (isLegacySingleDefaultFixed) {
          state.expenses.fixed = defaultFixedExpenseEntries();
        }
        const variableEntries = Array.isArray(state.expenses.variable)
          ? state.expenses.variable
          : state.expenses.variable
          ? [state.expenses.variable]
          : [];
        const isLegacySingleDefaultVariable =
          variableEntries.length === 1 &&
          String(variableEntries[0]?.label || "").trim().toLowerCase() === "alimentation" &&
          toNumber(variableEntries[0]?.amount) === 0 &&
          String(variableEntries[0]?.frequency || "mensuel").trim().toLowerCase() === "mensuel";
        state.expenses.variable = variableEntries;
        if (!state.expenses.variable.length || isLegacySingleDefaultVariable) {
          state.expenses.variable = defaultVariableExpenseEntries();
        }

        if (!state.allocationPlan || typeof state.allocationPlan !== "object") {
          state.allocationPlan = {
            leisureMonthly: 0,
            shortTerm: {
              enabled: false,
              type: "vacances",
              horizonYears: 1,
              amount: 0,
            },
            longTerm: {
              enabled: false,
              type: "security",
              horizonYears: 10,
              amount: 12000,
            },
            goalMode: "horizon",
          };
        }
        if (!state.allocationPlan.shortTerm || typeof state.allocationPlan.shortTerm !== "object") {
          state.allocationPlan.shortTerm = {
            enabled: false,
            type: "vacances",
            horizonYears: 1,
            amount: 0,
          };
        }
        if (!state.allocationPlan.longTerm || typeof state.allocationPlan.longTerm !== "object") {
          state.allocationPlan.longTerm = {
            enabled: false,
            type: "security",
            horizonYears: 10,
            amount: 12000,
          };
        }
        const allowedShort = new Set(["vacances", "cadeaux", "voiture", "mariage", "autre"]);
        const allowedLong = new Set(["security", "home", "invest", "children", "retirement"]);
        state.allocationPlan.shortTerm.enabled = Boolean(state.allocationPlan.shortTerm.enabled);
        state.allocationPlan.shortTerm.type = allowedShort.has(state.allocationPlan.shortTerm.type)
          ? state.allocationPlan.shortTerm.type
          : "vacances";
        state.allocationPlan.shortTerm.horizonYears = Math.min(
          3,
          Math.max(1, toInteger(state.allocationPlan.shortTerm.horizonYears || 1))
        );
        state.allocationPlan.shortTerm.amount = Math.max(0, toNumber(state.allocationPlan.shortTerm.amount || 0));

        state.allocationPlan.longTerm.enabled = Boolean(state.allocationPlan.longTerm.enabled);
        state.allocationPlan.longTerm.type = allowedLong.has(state.allocationPlan.longTerm.type)
          ? state.allocationPlan.longTerm.type
          : "security";
        state.allocationPlan.longTerm.horizonYears = Math.min(
          30,
          Math.max(3, toInteger(state.allocationPlan.longTerm.horizonYears || 10))
        );
        state.allocationPlan.longTerm.amount = Math.max(0, toNumber(state.allocationPlan.longTerm.amount || 0));
        state.allocationPlan.leisureMonthly = Math.max(0, toNumber(state.allocationPlan.leisureMonthly || 0));
        state.allocationPlan.goalMode = "horizon";
      }
      if (state?.assets) {
        const assets = state.assets;
        if (!Array.isArray(assets.otherAssets) || !assets.otherAssets.length) {
          const legacyAmount = toNumber(assets.otherAssetsAmount ?? 0);
          const legacyType = assets.otherAssetsType ?? "";
          const legacyAccess = assets.otherAssetsAccess ?? "";
          const legacyEntries = [];
          if (legacyAmount || legacyType || legacyAccess) {
            legacyEntries.push({
              amount: legacyAmount,
              type: legacyType || "",
              access: legacyAccess || "",
            });
          }
          assets.otherAssets = legacyEntries.length ? legacyEntries : [defaultOtherAssetEntry()];
        }
        assets.otherAssets.forEach((entry) => {
          if (!entry || typeof entry !== "object") return;
          if (!entry.purpose) {
            entry.purpose = "anticipation";
          }
        });
        delete assets.otherAssetsAmount;
        delete assets.otherAssetsType;
        delete assets.otherAssetsAccess;
      }
      if (state) {
        const hadCreditLoans = Array.isArray(state.credits?.loans);
        if (!state.credits) {
          state.credits = { loans: [] };
        } else if (!hadCreditLoans) {
          state.credits.loans = [];
        }
        if (!hadCreditLoans) {
          const legacyLoans = Array.isArray(state.loans)
            ? state.loans
            : state.loans
            ? [state.loans]
            : [];
          if (legacyLoans.length) {
            state.credits.loans = legacyLoans.filter((loan) => loan && typeof loan === "object");
          }
        }
        if (!Array.isArray(state.credits.loans)) {
          state.credits.loans = [];
        }
        state.loans = state.credits.loans;
      }
      return state;
    }

      function safelyParse(value) {
        try {
          return JSON.parse(value);
        } catch (_error) {
          return {};
        }
      }

      function normalizeName(value) {
        return String(value || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim()
          .toLowerCase();
      }

      function createNameKey(first, last) {
        return `${normalizeName(first)}::${normalizeName(last)}`;
      }

      function registerPendingName(userId, pending) {
        if (!userId) return;
        const storedPending = pending || safelyParse(localStorage.getItem(PENDING_NAME_KEY));
        if (!storedPending || storedPending.userId !== userId || !storedPending.key) return;
        try {
          const index = safelyParse(localStorage.getItem(NAME_INDEX_KEY));
          index[storedPending.key] = userId;
          localStorage.setItem(NAME_INDEX_KEY, JSON.stringify(index));
        } catch (_error) {
          // ignore storage issues
        }
        localStorage.removeItem(PENDING_NAME_KEY);
      }

      function getPendingName() {
        return safelyParse(localStorage.getItem(PENDING_NAME_KEY));
      }

      function injectPendingName(state, pending, userId) {
        if (!state || !pending || pending.userId !== userId) return;
        state.personal = state.personal || {};
        state.personal.firstName = pending.firstName || state.personal.firstName;
        state.personal.lastName = pending.lastName || state.personal.lastName;
        if (!state.personal.prenom) {
          state.personal.prenom = state.personal.firstName;
        }
        if (!state.personal.nom) {
          state.personal.nom = state.personal.lastName;
        }
        if (!state.personal.displayName) {
          const displayName = [`${pending.firstName || ""}`, `${pending.lastName || ""}`]
            .map((part) => part.trim())
            .filter(Boolean)
            .join(" ");
          if (displayName) {
            state.personal.displayName = displayName;
          }
        }
        normalizePersonalIdentity(state.personal);
      }

      function injectActiveUserIdentity(state, userId) {
        if (!state || !userId) return;
        const activeUser = safelyParse(localStorage.getItem(STORAGE_KEY_ACTIVE_USER));
        if (!activeUser || activeUser.id !== userId) return;
        state.personal = state.personal || {};
        const personal = state.personal;
        const explicitDisplay = String(activeUser.displayName || activeUser.name || "").trim();
        const explicitFirstName = String(activeUser.firstName || "").trim();
        const explicitLastName = String(activeUser.lastName || "").trim();
        if (!personal.firstName && explicitFirstName) personal.firstName = explicitFirstName;
        if (!personal.lastName && explicitLastName) personal.lastName = explicitLastName;
        if (!personal.displayName && explicitDisplay && explicitDisplay !== userId) {
          personal.displayName = explicitDisplay;
        }
        if ((!personal.firstName || !personal.lastName) && explicitDisplay.includes(" ")) {
          const parts = explicitDisplay.split(/\s+/).filter(Boolean);
          if (!personal.firstName && parts[0]) personal.firstName = parts[0];
          if (!personal.lastName && parts.length > 1) personal.lastName = parts.slice(1).join(" ");
        }
        normalizePersonalIdentity(personal);
      }

      function ensureProfileIdentity(state, userId) {
        if (!state || typeof state !== "object") return;
        const stableId = String(state.profileId || state.id || userId || "").trim();
        if (!stableId) return;
        state.profileId = stableId;
        state.id = stableId;
        state.updatedAt = new Date().toISOString();
      }

      function normalizePersonalIdentity(personal = {}) {
        if (!personal || typeof personal !== "object") return personal;
        const firstName = String(personal.firstName || personal.prenom || "").trim();
        const lastName = String(personal.lastName || personal.nom || "").trim();
        if (firstName) {
          personal.firstName = firstName;
          personal.prenom = firstName;
        }
        if (lastName) {
          personal.lastName = lastName;
          personal.nom = lastName;
        }
        const displayName = String(
          personal.displayName || personal.fullName || [firstName, lastName].filter(Boolean).join(" ")
        ).trim();
        if (displayName) {
          personal.displayName = displayName;
          personal.fullName = displayName;
        }
        return personal;
      }

      function syncCompletedProfile(userId, state) {
        const url = resolveProfileSyncTarget();
        if (!SYNC_ENABLED || !url || !userId) return Promise.resolve();
        const payload = JSON.parse(JSON.stringify(state || {}));
        ensureProfileIdentity(payload, userId);
        payload.personal = payload.personal && typeof payload.personal === "object" ? payload.personal : {};
        normalizePersonalIdentity(payload.personal);
        console.log("[sync] submit profile", { target: url, profileId: payload.profileId });
        return fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          keepalive: true,
          body: JSON.stringify(payload),
        })
          .then(async (response) => {
            if (!response.ok) {
              const raw = await response.text().catch(() => "");
              console.warn("[sync] non-2xx response from formulaire", {
                status: response.status,
                statusText: response.statusText,
                body: raw,
              });
            }
          })
          .catch((error) => {
            console.warn("[sync] profile push failed from formulaire", error);
          });
      }

      function resolveProfileSyncTarget() {
        const runtime = typeof window.getSmartSaveRuntime === "function"
          ? window.getSmartSaveRuntime()
          : {};
        const runtimeUrl = String(runtime?.automations?.profileSyncWebhookUrl || "").trim();
        const overrideUrl = String(localStorage.getItem(SYNC_URL_OVERRIDE_KEY) || "").trim();
        const preferred = runtimeUrl || overrideUrl;
        if (preferred) return preferred;
        const fallback = String(SYNC_URL || "").trim();
        if (!fallback) return "";
        return /\/sync$/i.test(fallback) ? fallback : `${fallback.replace(/\/+$/, "")}/sync`;
      }

    function getActiveUserId() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_ACTIVE_USER);
        if (!raw) return "";
        const parsed = JSON.parse(raw);
        return parsed?.id || "";
      } catch (_error) {
        return "";
      }
    }

    function toNumber(value) {
      if (typeof value === "number") return Number.isFinite(value) ? value : 0;
      const parsed = parseFloat(String(value).replace(/\s/g, "").replace(/’/g, "").replace(",", "."));
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat("fr-CH", {
        style: "currency",
        currency: "CHF",
        maximumFractionDigits: 0,
      }).format(toNumber(value));
    }

    function toInteger(value) {
      if (value === "" || value === undefined || value === null) return 0;
      const parsed = parseInt(value, 10);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function toValueString(value) {
      if (value === 0) return "0";
      return value ? String(value) : "";
    }
  </script>
  <script src="/dev-reload.js" defer></script>
</body>
</html>
