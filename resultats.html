<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <title>SmartSave - Synthese</title>
    <link rel="stylesheet" href="styles.css?v=20260212-01" />
    <script src="device-mode.js?v=20260213-01" defer></script>
    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --line: #e2e8f0;
      }

      * {
        box-sizing: border-box;
      }

      body.results-summary {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Avenir Next", "Segoe UI", sans-serif;
      }

      .page {
        width: min(760px, 100%);
        margin: 0 auto;
        padding: clamp(0.95rem, 3vw, 1.5rem);
        display: grid;
        gap: 1rem;
      }

      .summary-head {
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--line);
        display: grid;
        gap: 0.28rem;
      }

      .summary-head h1 {
        margin: 0;
        font-size: clamp(1.2rem, 3vw, 1.55rem);
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .summary-head p {
        margin: 0;
        font-size: 0.93rem;
      }

      .summary-person {
        color: #0f172a;
      }

      .summary-birth {
        color: var(--muted);
      }

      .section {
        display: grid;
        gap: 0.6rem;
        padding-bottom: 0.9rem;
        border-bottom: 1px solid var(--line);
      }

      .section h2 {
        margin: 0;
        font-size: 1rem;
      }

      .simple-list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 0.44rem;
      }

      .simple-row {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.65rem;
      }

      .row-label {
        color: #334155;
        font-size: 0.92rem;
        line-height: 1.35;
      }

      .row-value {
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
        font-size: 0.92rem;
        color: #0f172a;
      }

      .row-value.is-debt {
        color: #7f1d1d;
      }

      .empty {
        margin: 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .total-block {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.7rem;
        padding-top: 0.2rem;
      }

      .total-block span {
        color: #334155;
        font-size: 0.95rem;
      }

      .total-block strong {
        font-size: clamp(1.08rem, 3vw, 1.32rem);
        font-variant-numeric: tabular-nums;
      }

      .cta-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.6rem;
      }

      .cta {
        display: inline-flex;
        width: 100%;
        align-items: center;
        justify-content: center;
        text-align: center;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.95rem;
        padding: 0.82rem 1rem;
      }

      .cta--primary {
        border: 1px solid rgba(15, 23, 42, 0.68);
        color: #ffffff;
        background: linear-gradient(135deg, #0f172a, #1e293b);
      }

      .cta--secondary {
        border: 1px solid rgba(15, 23, 42, 0.25);
        color: #0f172a;
        background: #ffffff;
      }

      @media (max-width: 640px) {
        .cta-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="results-summary">
    <main class="page">
      <header class="summary-head">
        <h1>Synthese</h1>
        <p class="summary-person"><strong data-person-name>Profil</strong></p>
        <p class="summary-birth">Date de naissance : <span data-person-birth>Non renseignee</span></p>
      </header>

      <section class="section" id="accounts-section">
        <h2>Comptes</h2>
        <ul class="simple-list" data-accounts-list></ul>
        <p class="empty" data-accounts-empty hidden>Aucun compte avec montant renseigne.</p>
      </section>

      <section class="section" id="investments-section" hidden>
        <h2>Investissements</h2>
        <ul class="simple-list" data-investments-list></ul>
        <p class="empty" data-investments-empty hidden>Investissements declares sans montant renseigne.</p>
      </section>

      <section class="section" id="wealth-section">
        <h2>Patrimoine</h2>
        <ul class="simple-list" data-wealth-list></ul>
        <p class="empty" data-wealth-empty hidden>Aucun element de patrimoine renseigne.</p>
      </section>

      <section class="total-block" aria-label="Patrimoine total">
        <span>Patrimoine total</span>
        <strong data-total-networth>Non renseigne</strong>
      </section>

      <div class="cta-row">
        <a class="cta cta--primary" href="budget.html">Faire mon budget</a>
        <a class="cta cta--secondary" href="formulaire.html">Retour au formulaire</a>
      </div>
    </main>

    <script>
      (function () {
        const ACTIVE_USER_KEY = "smartsaveActiveUser";
        const FORM_KEY = "smartsaveFormData";
        const RECAP_PENDING_KEY = "smartsaveRecapPendingByUser";
        const RECAP_VERSION_KEY = "smartsaveRecapVersionByUser";
        const CURRENT_RECAP_VERSION = "20260212-v2";

        const safeParse = (value, fallback = null) => {
          if (!value) return fallback;
          try {
            return JSON.parse(value);
          } catch (_error) {
            return fallback;
          }
        };

        const toNumber = (value) => {
          const parsed = Number(String(value ?? "").replace(/[^0-9.-]/g, ""));
          return Number.isFinite(parsed) ? parsed : 0;
        };

        const toPositive = (value) => Math.max(0, toNumber(value));
        const ensureArray = (value) => (Array.isArray(value) ? value : value ? [value] : []);

        const formatCurrency = (value) =>
          new Intl.NumberFormat("fr-CH", {
            style: "currency",
            currency: "CHF",
            maximumFractionDigits: 0,
          }).format(Math.round(toNumber(value)));

        const formatSignedCurrency = (value) => {
          const amount = toNumber(value);
          const abs = formatCurrency(Math.abs(amount));
          return amount < 0 ? `-${abs}` : abs;
        };

        const formatDate = (value) => {
          if (!value) return "Non renseignee";
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return "Non renseignee";
          return new Intl.DateTimeFormat("fr-CH", { dateStyle: "long" }).format(date);
        };

        const text = (value, fallback = "") => {
          const normalized = String(value ?? "").trim();
          return normalized || fallback;
        };

        const escapeHtml = (value) =>
          String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");

        const setText = (selector, value) => {
          const node = document.querySelector(selector);
          if (node) node.textContent = value;
        };

        const renderSimpleRows = (selector, rows) => {
          const node = document.querySelector(selector);
          if (!node) return;
          node.innerHTML = rows
            .map(
              (row) => `
                <li class="simple-row">
                  <span class="row-label">${escapeHtml(row.label)}</span>
                  <strong class="row-value${row.isDebt ? " is-debt" : ""}">${escapeHtml(row.value)}</strong>
                </li>
              `
            )
            .join("");
        };

        const activeUser = safeParse(localStorage.getItem(ACTIVE_USER_KEY), {}) || {};
        const userId = String(activeUser.id || "").trim();
        if (!userId) {
          window.location.href = "index.html";
          return;
        }

        const recapPending = safeParse(localStorage.getItem(RECAP_PENDING_KEY), {}) || {};
        recapPending[userId] = false;
        localStorage.setItem(RECAP_PENDING_KEY, JSON.stringify(recapPending));

        const recapVersion = safeParse(localStorage.getItem(RECAP_VERSION_KEY), {}) || {};
        recapVersion[userId] = CURRENT_RECAP_VERSION;
        localStorage.setItem(RECAP_VERSION_KEY, JSON.stringify(recapVersion));

        const formStore = safeParse(localStorage.getItem(FORM_KEY), {}) || {};
        const formData = formStore[userId] || formStore.__default || {};

        const personal = formData.personal || {};
        const assets = formData.assets || {};
        const investments = formData.investments || {};
        const credits = formData.credits || {};
        const loans = ensureArray(credits.loans || formData.loans);

        const fullName = text(
          [
            personal.firstName || personal.prenom || activeUser.firstName || "",
            personal.lastName || personal.nom || activeUser.lastName || "",
          ]
            .filter(Boolean)
            .join(" "),
          "Profil"
        );

        setText("[data-person-name]", fullName);
        setText("[data-person-birth]", formatDate(personal.birthDate));

        const accountRows = [];
        let accountsTotal = 0;
        const pushAccount = (label, amount) => {
          const safe = toPositive(amount);
          if (safe > 0) {
            accountRows.push({ label, value: formatCurrency(safe) });
            accountsTotal += safe;
          }
        };

        pushAccount("Compte courant", assets.currentAccount);
        pushAccount("Compte epargne", assets.savingsAccount);
        pushAccount("3e pilier", assets.thirdPillarAmount);
        pushAccount("Compte impots", assets.taxAccountAmount);

        const otherAccounts = ensureArray(assets.otherAssets)
          .filter((entry) => entry && typeof entry === "object")
          .map((entry, index) => ({
            name: text(entry.name, `Autre compte ${index + 1}`),
            amount: toPositive(entry.amount),
          }))
          .filter((entry) => entry.amount > 0);

        otherAccounts.forEach((entry) => {
          pushAccount(entry.name, entry.amount);
        });

        renderSimpleRows("[data-accounts-list]", accountRows);
        const accountsEmpty = document.querySelector("[data-accounts-empty]");
        if (accountsEmpty) accountsEmpty.hidden = accountRows.length > 0;

        const investmentTypeLabel = (value) => {
          const map = {
            etf: "ETF",
            fonds: "Fonds",
            actions: "Actions",
            obligations: "Obligations",
            pilier3a: "3a bancaire",
            crypto: "Crypto",
            autre: "Autre",
          };
          return map[String(value || "").toLowerCase()] || text(value, "Investissement");
        };

        const hasInvestmentsFlag = String(investments.hasInvestments || "").toLowerCase() === "oui";
        const investmentItems = ensureArray(investments.items)
          .filter((entry) => entry && typeof entry === "object")
          .map((entry) => ({
            label: investmentTypeLabel(entry.investmentType),
            amount: toPositive(entry.amount),
            monthly: toPositive(entry.monthlyAmount),
          }));

        const investmentRows = investmentItems
          .filter((entry) => entry.amount > 0 || entry.monthly > 0)
          .map((entry) => {
            let value = "";
            if (entry.amount > 0 && entry.monthly > 0) {
              value = `${formatCurrency(entry.amount)} Â· ${formatCurrency(entry.monthly)} / mois`;
            } else if (entry.amount > 0) {
              value = formatCurrency(entry.amount);
            } else {
              value = `${formatCurrency(entry.monthly)} / mois`;
            }
            return { label: entry.label, value };
          });

        const investmentsSection = document.querySelector("[data-investments-section]");
        const investmentsEmpty = document.querySelector("[data-investments-empty]");
        const showInvestments = hasInvestmentsFlag || investmentItems.length > 0;
        if (investmentsSection) investmentsSection.hidden = !showInvestments;
        if (showInvestments) {
          renderSimpleRows("[data-investments-list]", investmentRows);
          if (investmentsEmpty) investmentsEmpty.hidden = investmentRows.length > 0;
        }

        const loanTypeLabel = (value) => {
          const map = {
            consommation: "Credit conso",
            leasing: "Leasing voiture",
            carte_credit: "Carte de credit",
            hypotheque: "Hypotheque",
            autre: "Autre dette",
          };
          return map[String(value || "").toLowerCase()] || text(value, "Dette");
        };

        const wealthRows = [];
        let wealthAssetsTotal = 0;
        let wealthDebtsTotal = 0;

        const propertyValue = toPositive(credits.propertyValue);
        const vehicleValue = toPositive(credits.vehicleValue);
        const mortgageBalance = toPositive(credits.mortgageBalance);

        if (propertyValue > 0) {
          wealthRows.push({ label: "Biens immobiliers", value: formatCurrency(propertyValue) });
          wealthAssetsTotal += propertyValue;
        }

        if (vehicleValue > 0) {
          wealthRows.push({ label: "Vehicules", value: formatCurrency(vehicleValue) });
          wealthAssetsTotal += vehicleValue;
        }

        if (propertyValue === 0 && vehicleValue === 0) {
          const declaredAssets = toPositive(credits.assetsTotal);
          if (declaredAssets > 0) {
            wealthRows.push({ label: "Patrimoine declare (biens)", value: formatCurrency(declaredAssets) });
            wealthAssetsTotal += declaredAssets;
          }
        }

        if (mortgageBalance > 0) {
          wealthRows.push({
            label: "Hypotheque restante",
            value: `-${formatCurrency(mortgageBalance)}`,
            isDebt: true,
          });
          wealthDebtsTotal += mortgageBalance;
        }

        const loansOutstanding = loans
          .filter((loan) => loan && typeof loan === "object")
          .map((loan) => ({
            label: loanTypeLabel(loan.creditType),
            amount: toPositive(loan.outstanding),
          }))
          .filter((loan) => loan.amount > 0);

        loansOutstanding.forEach((loan) => {
          wealthRows.push({
            label: loan.label,
            value: `-${formatCurrency(loan.amount)}`,
            isDebt: true,
          });
          wealthDebtsTotal += loan.amount;
        });

        const declaredDebtTotal = toPositive(credits.debtsTotal);
        if (declaredDebtTotal > wealthDebtsTotal) {
          const deltaDebt = declaredDebtTotal - wealthDebtsTotal;
          wealthRows.push({
            label: "Autres dettes declarees",
            value: `-${formatCurrency(deltaDebt)}`,
            isDebt: true,
          });
          wealthDebtsTotal += deltaDebt;
        }

        renderSimpleRows("[data-wealth-list]", wealthRows);
        const wealthEmpty = document.querySelector("[data-wealth-empty]");
        if (wealthEmpty) wealthEmpty.hidden = wealthRows.length > 0;

        const investmentsTotal = investmentItems.reduce((sum, entry) => sum + entry.amount, 0);
        const netWorth = accountsTotal + investmentsTotal + wealthAssetsTotal - wealthDebtsTotal;

        const totalNode = document.querySelector("[data-total-networth]");
        if (totalNode) {
          if (Math.abs(netWorth) > 0) {
            totalNode.textContent = formatSignedCurrency(netWorth);
          } else {
            totalNode.textContent = "Non renseigne";
          }
        }
      })();
    </script>
    <script src="/dev-reload.js?v=20260212-01" defer></script>
  </body>
</html>
